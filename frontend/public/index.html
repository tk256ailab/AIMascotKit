<!DOCTYPE html>
<html lang="ja">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIMascotKit</title>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: transparent;
        }
        
        #vrmCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* „É°„Éã„É•„Éº„Éú„Çø„É≥ */
        #menuToggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            z-index: 1001;
            transition: all 0.3s ease;
            width: 60px;
            height: 60px;
            min-width: 60px;
            min-height: 60px;
            max-width: 60px;
            max-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }
        
        #menuToggle:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        #menuToggle.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.8);
        }
        
        /* „É°„Éã„É•„Éº„Éë„Éç„É´ */
        #menuPanel {
            position: absolute;
            top: 20px;
            left: 80px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            min-width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transform: translateX(-500px);
            transition: transform 0.3s ease;
        }
        
        #menuPanel.open {
            transform: translateX(0);
        }
        
        #menuPanel.auto-hide {
            transform: translateX(-500px);
            transition: transform 0.3s ease;
        }
        
        .menu-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .menu-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .menu-section h3 {
            margin: 0 0 10px 0;
            color: #e0e0e0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .control-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .expression-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 12px;
            min-width: 80px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .animation-btn {
            background: linear-gradient(135deg, #4CAF50, #2e8b57);
            color: white;
            font-size: 11px;
        }
        
        .expression-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 11px;
        }
        
        .sample-btn {
            background: linear-gradient(135deg, #ffa502, #ff6348);
            color: white;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }
        
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            width: 100%;
        }
        
        select option {
            background: #333;
            color: white;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* „ÅîÊ©üÂ´åÂ∫¶„É°„Éº„Çø„Éº */
        /* „Ç¥Ê©üÂ´åÂ∫¶„É°„Éº„Çø„Éº - „Éè„Éº„Éà&„Éî„É≥„ÇØ„ÉÜ„Éº„Éû */
        #moodMeter {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.95), rgba(255, 192, 203, 0.9));
            padding: 20px;
            border-radius: 20px;
            color: #ff1493;
            z-index: 999;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
            border: 3px solid #ffb6c1;
            box-shadow: 0 8px 25px rgba(255, 20, 147, 0.3);
            text-align: center;
            font-family: 'Kiwi Maru', sans-serif;
            font-weight: bold;
        }
        
        #moodMeter.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .mood-bar {
            width: 30px;
            height: 200px;
            background: linear-gradient(to top, 
                rgba(139, 69, 19, 0.9) 0%,
                rgba(220, 20, 60, 0.8) 20%,
                rgba(255, 105, 180, 0.8) 40%,
                rgba(255, 182, 193, 0.9) 60%,
                rgba(255, 192, 203, 0.9) 80%,
                rgba(255, 240, 245, 1.0) 100%);
            border-radius: 15px;
            position: relative;
            margin: 10px auto;
            border: 2px solid #ff69b4;
            box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
        }
        
        .mood-indicator {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: transparent;
            border-radius: 50%;
            transition: bottom 0.5s ease;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: heartbeat 1.5s ease-in-out infinite;
            text-shadow: 0 2px 8px rgba(255, 20, 147, 0.6);
        }
        
        @keyframes heartbeat {
            0%, 100% {
                transform: translateX(-50%) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.1);
            }
        }
        
        #statusDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 999;
            backdrop-filter: blur(10px);
        }
        
        /* AITuberË¶ñÁÇπÂàá„ÇäÊõø„Åà„Éú„Çø„É≥ - „Ç¢„Ç§„Ç≥„É≥„ÅÆ„Åø */
        #visionToggleButton {
            position: absolute;
            top: 90px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            padding: 0;
            font-size: 20px;
            cursor: pointer;
            z-index: 10002;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            min-width: 50px;
            min-height: 50px;
            max-width: 50px;
            max-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }

        #visionToggleButton:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        #visionToggleButton.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.8);
        }

        /* AITuberË¶ñÁÇπÁîªÂÉè„Ç®„É™„Ç¢ */
        #aiTuberVision {
            position: absolute;
            top: 150px;
            left: 20px;
            width: 300px;
            height: 200px;
            background: linear-gradient(135deg, #fff4e6 0%, #ffecd1 100%);
            border: 4px solid #ff8c42;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(255, 111, 0, 0.4);
            z-index: 9998;
            overflow: hidden;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            opacity: 1;
            visibility: visible;
        }

        #aiTuberVision.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-20px);
        }

        #aiTuberVision:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 111, 0, 0.5);
        }

        #aiTuberVision.hidden:hover {
            transform: translateY(-20px) scale(1.02);
        }

        #visionLabel {
            position: absolute;
            top: -15px;
            left: 15px;
            background: linear-gradient(45deg, #ff8c42, #ff6f00);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-family: 'Kiwi Maru', sans-serif;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 111, 0, 0.3);
            z-index: 9999;
        }

        #visionImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        #visionPlaceholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ff6f00;
            font-family: 'Kiwi Maru', sans-serif;
            font-size: 16px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #visionPlaceholder .icon {
            font-size: 48px;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        /* „ÉÜ„Éº„Éû„Ç´„É©„ÉºÁî®CSSÂ§âÊï∞ */
        :root {
            --theme-primary: #ff1493;
            --theme-secondary: #ffb6c1;
            --theme-bg-start: rgba(255, 182, 193, 0.95);
            --theme-bg-end: rgba(255, 192, 203, 0.9);
            --theme-shadow: rgba(255, 20, 147, 0.4);
        }
        
        /* Â≠óÂπïË°®Á§∫ - „ÉÜ„Éº„Éû„Ç´„É©„ÉºÂØæÂøú */
        #subtitle {
            position: absolute;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--theme-bg-start), var(--theme-bg-end));
            color: var(--theme-primary);
            font-size: 24px;
            padding: 18px 35px;
            border-radius: 25px;
            pointer-events: none;
            max-width: 85%;
            text-align: center;
            font-family: 'Kiwi Maru', sans-serif;
            z-index: 99999;
            box-shadow: 0 8px 25px var(--theme-shadow);
            border: 3px solid var(--theme-secondary);
            backdrop-filter: blur(12px);
            animation: floatBounce 2.5s ease-in-out infinite;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            font-weight: bold;
        }

        #subtitle.show {
            opacity: 1;
            visibility: visible;
        }

        @keyframes floatBounce {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-10px);
            }
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }
        
        /* ÂÖÉ„ÅÆÂ≠óÂπïË°®Á§∫„ÅØÈö†„Åô */
        #subtitleDisplay {
            display: none;
        }
        
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            z-index: 2000;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë©≥Á¥∞„É°„Éã„É•„Éº */
        #animationDetailMenu {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        
        #animationDetailMenu.open {
            display: block;
        }
    </style>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/",
            "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js",
            "@pixiv/three-vrm-animation": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm-animation@3/lib/three-vrm-animation.module.min.js"
        }
    }
    </script>
</head>
<body>
    <div id="loadingOverlay">
        <div>VRM AITuber„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ‰∏≠...</div>
    </div>
    
    <canvas id="vrmCanvas"></canvas>
    
    <button id="menuToggle">‚ò∞</button>
    
    <div id="menuPanel">
        <div class="menu-section">
            <h3>VRM„É¢„Éá„É´ÈÅ∏Êäû</h3>
            <div class="control-group">
                <select id="characterSelect">
                    <option value="sample" selected>„Çµ„É≥„Éó„É´</option>
                </select>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>„ÉÜ„Éº„Éû„Ç´„É©„ÉºË®≠ÂÆö</h3>
            <div class="control-group">
                <label>Â≠óÂπï„ÉÜ„Éº„Éû</label>
                <select id="themeSelect">
                    <option value="pink" selected>„Éî„É≥„ÇØ</option>
                    <option value="blue">„Éñ„É´„Éº</option>
                    <option value="green">„Ç∞„É™„Éº„É≥</option>
                    <option value="purple">„Éë„Éº„Éó„É´</option>
                    <option value="orange">„Ç™„É¨„É≥„Ç∏</option>
                    <option value="cyan">„Ç∑„Ç¢„É≥</option>
                    <option value="red">„É¨„ÉÉ„Éâ</option>
                    <option value="yellow">„Ç§„Ç®„É≠„Éº</option>
                    <option value="indigo">„Ç§„É≥„Éá„Ç£„Ç¥</option>
                    <option value="teal">„ÉÜ„Ç£„Éº„É´</option>
                    <option value="magenta">„Éû„Çº„É≥„Çø</option>
                    <option value="lime">„É©„Ç§„É†</option>
                </select>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Â≠óÂπïË®≠ÂÆö</h3>
            <div class="control-group">
                <div class="toggle-switch">
                    <span>Êó•Êú¨Ë™ûË°®Á§∫</span>
                    <label class="switch">
                        <input type="checkbox" id="japaneseToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="control-group">
                <div class="toggle-switch">
                    <span>Ëã±Ë™ûË°®Á§∫</span>
                    <label class="switch">
                        <input type="checkbox" id="englishToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>„ÅîÊ©üÂ´åÂ∫¶Ë°®Á§∫</h3>
            <div class="toggle-switch">
                <span>Ë°®Á§∫</span>
                <label class="switch">
                    <input type="checkbox" id="moodToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>„Çµ„É≥„Éó„É´Èü≥Â£∞</h3>
            <div class="button-row">
                <button class="sample-btn" id="sampleVoiceBtn">„Çµ„É≥„Éó„É´Èü≥Â£∞ÂÜçÁîü</button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÉÜ„Çπ„Éà</h3>
            <div class="button-row">
                <button class="primary-btn" id="animationTestBtn">Ë©≥Á¥∞„É°„Éã„É•„Éº„ÇíÈñã„Åè</button>
                <button class="primary-btn" id="stopAnimationBtn">„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢</button>
            </div>
            
            <div id="animationDetailMenu">
                <h4 style="margin-top: 0; color: #e0e0e0;">ÊÑüÊÉÖ„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥</h4>
                <div class="button-grid">
                    <button class="animation-btn" data-animation="Angry">üò† Angry</button>
                    <button class="animation-btn" data-animation="Sad">üò¢ Sad</button>
                    <button class="animation-btn" data-animation="Surprised">üò≤ Surprised</button>
                    <button class="animation-btn" data-animation="Blush">üòä Blush</button>
                    <button class="animation-btn" data-animation="Sleepy">üò¥ Sleepy</button>
                    <button class="animation-btn" data-animation="Thinking">ü§î Thinking</button>
                </div>
                
                <h4 style="color: #e0e0e0; margin-top: 15px;">„Ç¢„ÇØ„Ç∑„Éß„É≥„ÉªÂãï‰Ωú</h4>
                <div class="button-grid">
                    <button class="animation-btn" data-animation="Clapping">üëè Clapping</button>
                    <button class="animation-btn" data-animation="Jump">ü¶ò Jump</button>
                    <button class="animation-btn" data-animation="JumpHigh">‚¨ÜÔ∏è Jump High</button>
                    <button class="animation-btn" data-animation="Goodbye">üëã Goodbye</button>
                    <button class="animation-btn" data-animation="Relax">üòå Relax</button>
                    <button class="animation-btn" data-animation="LookAround">üëÄ Look Around</button>
                </div>
                
                <h4 style="color: #e0e0e0; margin-top: 15px;">ËøΩÂä†„Ç¢„ÇØ„Ç∑„Éß„É≥</h4>
                <div class="button-grid">
                    <button class="animation-btn" data-animation="LookAround2">üëÅÔ∏è Look Around 2</button>
                </div>
                
                <h4 style="color: #e0e0e0; margin-top: 15px;">Ë°®ÊÉÖ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ</h4>
                <div class="button-row" style="margin-bottom: 10px;">
                    <button class="primary-btn" id="resetExpressionBtn">Ë°®ÊÉÖ„É™„Çª„ÉÉ„Éà</button>
                </div>
                <div class="expression-grid">
                    <button class="expression-btn" data-expression="happy">üòä Happy</button>
                    <button class="expression-btn" data-expression="angry">üò† Angry</button>
                    <button class="expression-btn" data-expression="sad">üò¢ Sad</button>
                    <button class="expression-btn" data-expression="surprised">üò≤ Surprised</button>
                    <button class="expression-btn" data-expression="relaxed">üòå Relaxed</button>
                    <button class="expression-btn" data-expression="neutral">üòê Neutral</button>
                </div>
                
                <h4 style="color: #e0e0e0; margin-top: 15px;">VRMÂõ∫ÊúâË°®ÊÉÖ</h4>
                <div id="dynamicExpressionsGrid" class="expression-grid">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="moodMeter">
        <div style="text-align: center; margin-bottom: 10px;">„ÅîÊ©üÂ´åÂ∫¶</div>
        <div class="mood-bar">
            <div class="mood-indicator" id="moodIndicator">üíñ</div>
        </div>
        <div id="moodValue" style="text-align: center; font-size: 16px; margin-top: 10px;">75</div>
    </div>
    
    <div id="statusDisplay">ÂàùÊúüÂåñ‰∏≠...</div>
    
    <button id="visionToggleButton">üëÅÔ∏è</button>

    <div id="aiTuberVision" class="hidden">
        <div id="visionLabel">üëÅÔ∏è AITuber„ÅÆË¶ñÁÇπ</div>
        <img id="visionImage" style="display: none;" alt="AITuberË¶ñÁÇπÁîªÂÉè">
        <div id="visionPlaceholder">
            <div class="icon">üëÄ</div>
            <div>ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
    </div>

    <div id="subtitle"></div>
    <div id="subtitleDisplay" class="hidden">
        <span class="japanese"></span>
        <span class="english"></span>
    </div>
    
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';
        import { VRMAnimationLoaderPlugin, createVRMAnimationClip } from '@pixiv/three-vrm-animation';

        class VRMAITuberSystem {
            constructor() {
                this.currentVRM = null;
                this.vrmMixer = null;
                this.currentAction = null;
                this.currentExpressionAction = null;
                this.vrmClock = new THREE.Clock();
                this.isBlinking = false;
                this.blinkTimer = null;
                
                // Âè£„Éë„ÇØÈñ¢ÈÄ£Â§âÊï∞
                this.isLipSyncActive = false;
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.lipSyncAnimationFrame = null;
                this.currentVowelExpression = 'a';
                this.lastVowelChangeTime = 0;
                this.lipSyncVowels = ['a', 'i', 'u', 'e', 'o'];
                
                // Ë°®ÊÉÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁÆ°ÁêÜ
                this.currentExpressionValues = {};
                this.targetExpressionValues = {};
                this.expressionAnimationFrame = null;
                this.isExpressionAnimating = false;
                this.expressionAnimationStartTime = 0;
                this.expressionAnimationDuration = 800; // 800ms„ÅßËá™ÁÑ∂„Å™Â§âÂåñ
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅ∑ÁßªÁÆ°ÁêÜ
                this.animationFinishedListener = null;
                
                // „É´„Éº„Éó„Çπ„É†„Éº„Ç∏„É≥„Ç∞ÁÆ°ÁêÜ
                this.loopSmoothingFrame = null;
                this.currentIdleClip = null;
                
                // „Ç≠„É£„É©„ÇØ„Çø„Éº„Éë„ÇπÔºàindex.html„Åã„ÇâË¶ã„ÅüÁõ∏ÂØæ„Éë„ÇπÔºâ
                this.characterPaths = {
                    'sample': '../../assets/characters/Sample/vrm/Sample.vrm'
                };
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éë„Çπ
                this.animationBasePath = '../../assets/animations/';
                
                // DOMË¶ÅÁ¥†
                this.canvas = document.getElementById('vrmCanvas');
                this.menuToggle = document.getElementById('menuToggle');
                this.menuPanel = document.getElementById('menuPanel');
                this.characterSelect = document.getElementById('characterSelect');
                this.themeSelect = document.getElementById('themeSelect');
                this.japaneseToggle = document.getElementById('japaneseToggle');
                this.englishToggle = document.getElementById('englishToggle');
                this.moodToggle = document.getElementById('moodToggle');
                this.moodMeter = document.getElementById('moodMeter');
                this.moodIndicator = document.getElementById('moodIndicator');
                this.moodValue = document.getElementById('moodValue');
                this.statusDisplay = document.getElementById('statusDisplay');
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.animationTestBtn = document.getElementById('animationTestBtn');
                this.animationDetailMenu = document.getElementById('animationDetailMenu');
                this.sampleVoiceBtn = document.getElementById('sampleVoiceBtn');
                this.stopAnimationBtn = document.getElementById('stopAnimationBtn');
                this.resetExpressionBtn = document.getElementById('resetExpressionBtn');
                this.dynamicExpressionsGrid = document.getElementById('dynamicExpressionsGrid');
                this.subtitleDisplay = document.getElementById('subtitleDisplay');
                this.subtitle = document.getElementById('subtitle');
                this.visionToggleButton = document.getElementById('visionToggleButton');
                this.aiTuberVision = document.getElementById('aiTuberVision');
                this.visionImage = document.getElementById('visionImage');
                this.visionPlaceholder = document.getElementById('visionPlaceholder');
                
                // Ë¶ñÁÇπË°®Á§∫„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
                this.isVisionVisible = false;
                
                // „É°„Éã„É•„ÉºËá™ÂãïÈùûË°®Á§∫„Çø„Ç§„Éû„ÉºÔºàÁÑ°ÂäπÂåñÔºâ
                // this.menuAutoHideTimer = null;
                
                // Â≠óÂπïÈñ¢ÈÄ£
                this.lastSubtitleTimestamp = 0;
                this.subtitleSocket = null;
                
                // Èü≥Â£∞ÂÜçÁîü„Éù„Éº„É™„É≥„Ç∞Èñ¢ÈÄ£
                this.voicePollingInterval = null;
                
                // „ÅîÊ©üÂ´åÂ∫¶„Éù„Éº„É™„É≥„Ç∞Èñ¢ÈÄ£
                this.moodPollingInterval = null;
                this.currentMoodValue = 75; // ÂàùÊúüÂÄ§
                
                // ÊÑüÊÉÖ„ÉªË°®ÊÉÖ„Éù„Éº„É™„É≥„Ç∞Èñ¢ÈÄ£
                this.emotionPollingInterval = null;
                this.expressionPollingInterval = null;
                this.currentEmotion = null; // ÁèæÂú®„ÅÆÊÑüÊÉÖ
                this.currentExpressionFromBackend = null; // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„Çâ„ÅÆË°®ÊÉÖ
                this.currentEmotionalExpression = 'neutral'; // ÁèæÂú®„ÅÆÊÑüÊÉÖË°®ÊÉÖÔºàÈü≥Â£∞ÁµÇ‰∫ÜÊôÇ„É™„Çª„ÉÉ„ÉàÁî®Ôºâ
                
                // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊõ¥Êñ∞Èñ¢ÈÄ£ÔºàLive2D„Çπ„Çø„Ç§„É´Ôºâ
                this.lastScreenshotUpdate = 0; // ÊâãÂãïÊõ¥Êñ∞Áî®„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅÆ„Åø
                
                // Â≠óÂπïË®≠ÂÆö
                this.subtitleSettings = {
                    showJapanese: true,
                    showEnglish: true
                };
                
                // ÁèæÂú®„ÅÆÂ≠óÂπï„Çí„ÇØ„É™„Ç¢„Åô„Çã„Çø„Ç§„Éû„Éº
                this.subtitleClearTimer = null;
                
                this.initializeSystem();
            }
            
            async initializeSystem() {
                try {
                    this.updateStatus('VRM„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...');
                    this.setupEventListeners();
                    this.initializeThreeJS();
                    
                    this.updateStatus('„Éá„Éï„Ç©„É´„Éà„Ç≠„É£„É©„ÇØ„Çø„ÉºË™≠„ÅøËæº„Åø‰∏≠...');
                    await this.loadCharacter('sample');
                    
                    this.updateStatus('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã...');
                    await this.startIdleLoop();
                    this.startBlinking();
                    
                    this.updateStatus('ÂàùÊúüÂåñÂÆå‰∫Ü');
                    this.hideLoading();
                    
                    // Â≠óÂπïÊé•Á∂öÂàùÊúüÂåñ
                    this.initializeSubtitleConnection();
                    
                    // Èü≥Â£∞ÂÜçÁîü„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
                    this.initializeVoicePolling();
                    
                    // „ÅîÊ©üÂ´åÂ∫¶„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
                    this.initializeMoodPolling();
                    
                    // ÊÑüÊÉÖ„ÉªË°®ÊÉÖ„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
                    this.initializeEmotionPolling();
                    
                    // ÂàùÊúü„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàË®≠ÂÆö„Å®Ëá™ÂãïÊõ¥Êñ∞ÈñãÂßã
                    this.initializeScreenshotAutoUpdate();
                    
                } catch (error) {
                    console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                    this.updateStatus(`ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`);
                    setTimeout(() => this.hideLoading(), 3000);
                }
            }
            
            setupEventListeners() {
                // „É°„Éã„É•„Éº„Éà„Ç∞„É´
                this.menuToggle.addEventListener('click', () => {
                    this.toggleMenu();
                });
                
                // „É°„Éã„É•„ÉºÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßËá™ÂãïÈùûË°®Á§∫
                document.addEventListener('click', (e) => {
                    if (!this.menuPanel.contains(e.target) && !this.menuToggle.contains(e.target)) {
                        this.hideMenu();
                    }
                });
                
                // „É°„Éã„É•„ÉºÂÜÖ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç§„Éô„É≥„Éà‰ºùÊí≠„ÇíÂÅúÊ≠¢
                this.menuPanel.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
                this.characterSelect.addEventListener('change', (e) => {
                    this.loadCharacter(e.target.value);
                });
                
                // „ÉÜ„Éº„Éû„Ç´„É©„ÉºÈÅ∏Êäû
                this.themeSelect.addEventListener('change', (e) => {
                    this.changeTheme(e.target.value);
                });
                
                // Â≠óÂπïË®≠ÂÆö
                this.japaneseToggle.addEventListener('change', (e) => {
                    this.subtitleSettings.showJapanese = e.target.checked;
                    console.log('Êó•Êú¨Ë™ûË°®Á§∫:', this.subtitleSettings.showJapanese);
                });
                
                this.englishToggle.addEventListener('change', (e) => {
                    this.subtitleSettings.showEnglish = e.target.checked;
                    console.log('Ëã±Ë™ûË°®Á§∫:', this.subtitleSettings.showEnglish);
                });
                
                // „ÅîÊ©üÂ´åÂ∫¶Ë°®Á§∫Âàá„ÇäÊõø„Åà
                this.moodToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.moodMeter.classList.remove('hidden');
                    } else {
                        this.moodMeter.classList.add('hidden');
                    }
                });
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÉÜ„Çπ„ÉàË©≥Á¥∞„É°„Éã„É•„Éº
                this.animationTestBtn.addEventListener('click', () => {
                    this.animationDetailMenu.classList.toggle('open');
                    this.animationTestBtn.textContent = 
                        this.animationDetailMenu.classList.contains('open') ? 
                        'Ë©≥Á¥∞„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã' : 'Ë©≥Á¥∞„É°„Éã„É•„Éº„ÇíÈñã„Åè';
                });
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥
                document.querySelectorAll('.animation-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const animationName = btn.getAttribute('data-animation');
                        this.playAnimation(animationName);
                    });
                });
                
                // Ë°®ÊÉÖ„Éú„Çø„É≥
                document.querySelectorAll('.expression-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const expressionName = btn.getAttribute('data-expression');
                        this.setExpression(expressionName);
                    });
                });
                
                // „Çµ„É≥„Éó„É´Èü≥Â£∞
                this.sampleVoiceBtn.addEventListener('click', () => {
                    this.playSampleVoice();
                });
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢
                this.stopAnimationBtn.addEventListener('click', () => {
                    this.stopCurrentAnimation();
                });
                
                // Ë°®ÊÉÖ„É™„Çª„ÉÉ„Éà
                this.resetExpressionBtn.addEventListener('click', () => {
                    this.resetAllExpressions();
                });
                
                // Ë¶ñÁÇπË°®Á§∫„Éú„Çø„É≥
                this.visionToggleButton.addEventListener('click', () => {
                    this.toggleVision();
                });
                
                // Ë¶ñÁÇπË°®Á§∫„ÅÆÂ§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                document.addEventListener('click', (e) => {
                    if (this.isVisionVisible && 
                        !this.aiTuberVision.contains(e.target) && 
                        !this.visionToggleButton.contains(e.target)) {
                        this.toggleVision();
                    }
                });
                
                // Ë¶ñÁÇπË°®Á§∫ÂÜÖ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç§„Éô„É≥„Éà‰ºùÊí≠„ÇíÂÅúÊ≠¢
                this.aiTuberVision.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
                window.addEventListener('resize', () => this.handleResize());
            }
            
            initializeThreeJS() {
                // „É¨„É≥„ÉÄ„É©„ÉºÔºàÈÄèÊòéËÉåÊôØÂØæÂøúÔºâ
                this.renderer = new THREE.WebGLRenderer({
                    canvas: this.canvas,
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.outputEncoding = THREE.sRGBEncoding;
                this.renderer.setClearColor(0x000000, 0); // ÈÄèÊòéËÉåÊôØ„ÇíË®≠ÂÆö
                
                // „Ç´„É°„É©ÔºàÊ≠£Èù¢„ÇíÂêë„Åè„Çà„ÅÜ„Å´Ë®≠ÂÆöÔºâ
                this.camera = new THREE.PerspectiveCamera(
                    30.0,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    20.0
                );
                this.camera.position.set(0.0, 1.0, 3.0);
                
                // „Ç≥„É≥„Éà„É≠„Éº„É´
                this.controls = new OrbitControls(this.camera, this.canvas);
                this.controls.screenSpacePanning = true;
                this.controls.target.set(0.0, 1.0, 0.0);
                this.controls.update();
                
                // „Ç∑„Éº„É≥ÔºàÈÄèÊòéËÉåÊôØÔºâ
                this.scene = new THREE.Scene();
                // this.scene.background = new THREE.Color(0x212121); // ËÉåÊôØ„ÇíÈÄèÊòé„Å´„Åô„Çã„Åü„ÇÅ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà
                
                // „É©„Ç§„ÉàË®≠ÂÆöÔºàVRM„É¢„Éá„É´„ÇíÊòé„Çã„ÅèË°®Á§∫Ôºâ
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.2); // Âº∑Â∫¶„Çí2ÂÄç„Å´
                directionalLight.position.set(1.0, 1.0, 1.0).normalize();
                this.scene.add(directionalLight);
                
                // ËøΩÂä†„ÅÆÊ≠£Èù¢„É©„Ç§„Éà
                const frontLight = new THREE.DirectionalLight(0xffffff, 1.5);
                frontLight.position.set(0.0, 0.5, 1.0).normalize();
                this.scene.add(frontLight);
                
                // Â∑¶Âè≥„Åã„Çâ„ÅÆË£úÂä©„É©„Ç§„Éà
                const leftLight = new THREE.DirectionalLight(0xffffff, 0.8);
                leftLight.position.set(-1.0, 0.0, 0.5).normalize();
                this.scene.add(leftLight);
                
                const rightLight = new THREE.DirectionalLight(0xffffff, 0.8);
                rightLight.position.set(1.0, 0.0, 0.5).normalize();
                this.scene.add(rightLight);
                
                // „Ç¢„É≥„Éì„Ç®„É≥„Éà„É©„Ç§„Éà„ÇíÂº∑Âåñ
                const ambientLight = new THREE.AmbientLight(0xffffff, 1.2); // Âº∑Â∫¶„ÇíÂ¢óÂä†
                this.scene.add(ambientLight);
                
                // VRM„É≠„Éº„ÉÄ„Éº
                this.loader = new GLTFLoader();
                this.loader.register(parser => new VRMLoaderPlugin(parser));
                this.loader.register(parser => new VRMAnimationLoaderPlugin(parser));
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„ÉóÈñãÂßã
                this.startAnimationLoop();
            }
            
            toggleMenu() {
                if (this.menuPanel.classList.contains('open')) {
                    this.hideMenu();
                } else {
                    this.showMenu();
                }
            }
            
            showMenu() {
                this.menuPanel.classList.add('open');
                this.menuPanel.classList.remove('auto-hide');
                
                // Ëá™ÂãïÈùûË°®Á§∫„Çø„Ç§„Éû„Éº„ÇíÁÑ°ÂäπÂåñ
                // this.clearMenuAutoHideTimer();
                // this.menuAutoHideTimer = setTimeout(() => {
                //    this.hideMenu();
                // }, 10000);
            }
            
            hideMenu() {
                this.menuPanel.classList.remove('open');
                this.menuPanel.classList.add('auto-hide');
                // this.clearMenuAutoHideTimer();
            }
            
            // clearMenuAutoHideTimer() {
            //    if (this.menuAutoHideTimer) {
            //        clearTimeout(this.menuAutoHideTimer);
            //        this.menuAutoHideTimer = null;
            //    }
            // }
            
            async loadCharacter(characterId) {
                try {
                    this.updateStatus(`„Ç≠„É£„É©„ÇØ„Çø„ÉºË™≠„ÅøËæº„Åø‰∏≠: ${characterId}`);
                    
                    // ÁèæÂú®„ÅÆ„É¢„Éá„É´„ÇíËß£Êîæ
                    this.disposeCurrentVRM();
                    
                    const modelPath = this.characterPaths[characterId];
                    if (!modelPath) {
                        throw new Error(`Unknown character: ${characterId}`);
                    }
                    
                    const gltf = await new Promise((resolve, reject) => {
                        this.loader.load(
                            modelPath,
                            resolve,
                            (progress) => {
                                const percent = (progress.loaded / progress.total * 100).toFixed(1);
                                this.updateStatus(`Ë™≠„ÅøËæº„Åø‰∏≠: ${percent}%`);
                            },
                            reject
                        );
                    });
                    
                    const vrm = gltf.userData.vrm;
                    
                    // VRM„É¢„Éá„É´„ÇíÊ≠£Èù¢Âêë„Åç„Å´Ë™øÊï¥
                    vrm.scene.rotation.y = Math.PI;
                    
                    // VRM„É¢„Éá„É´„ÅÆÊòéÂ∫¶„ÇíË™øÊï¥
                    vrm.scene.traverse((child) => {
                        if (child.isMesh && child.material) {
                            // MToonMaterial„ÅÆÂ†¥Âêà
                            if (child.material.isMToonMaterial) {
                                // „Ç∑„Çß„Éº„Éá„Ç£„É≥„Ç∞„Ç∞„É¨„Éº„Éâ„ÇíË™øÊï¥„Åó„Å¶„Çà„ÇäÊòé„Çã„Åè
                                if (child.material.shadingGradeRate !== undefined) {
                                    child.material.shadingGradeRate = 0.2; // „Éá„Éï„Ç©„É´„Éà1.0„Çà„ÇäÊòé„Çã„Åè
                                }
                                // „Ç∑„Çß„Éº„Éá„Ç£„É≥„Ç∞„Ç∑„Éï„Éà„ÇíË™øÊï¥
                                if (child.material.shadingShiftRate !== undefined) {
                                    child.material.shadingShiftRate = -0.2; // „Çà„ÇäÊòé„Çã„ÅÑÂÅ¥„Å´„Ç∑„Éï„Éà
                                }
                                // „É©„Ç§„Éà„Ç´„É©„Éº„ÅÆÂº∑Â∫¶„Çí‰∏ä„Åí„Çã
                                if (child.material.litFactor !== undefined) {
                                    child.material.litFactor = Math.min(child.material.litFactor * 1.3, 1.0);
                                }
                            }
                            // ÈÄöÂ∏∏„ÅÆ„Éû„ÉÜ„É™„Ç¢„É´„ÅÆÂ†¥Âêà
                            else if (child.material.color) {
                                // „Ç´„É©„Éº„ÅÆÊòéÂ∫¶„ÇíÂ∞ë„Åó‰∏ä„Åí„Çã
                                child.material.color.multiplyScalar(1.2);
                            }
                            
                            // ÂΩ±„ÅÆÂèó„ÅëÂèñ„Çä„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„Çà„ÇäÊòé„Çã„Åè
                            child.receiveShadow = false;
                            child.castShadow = false;
                        }
                    });
                    
                    this.scene.add(vrm.scene);
                    this.currentVRM = vrm;
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éü„Ç≠„Çµ„Éº„Çí‰ΩúÊàê
                    this.vrmMixer = new THREE.AnimationMixer(vrm.scene);
                    
                    // „Éü„Ç≠„Çµ„Éº„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞„Åó„ÅÑVRMË™≠„ÅøËæº„ÅøÊôÇÔºâ
                    if (this.animationFinishedListener) {
                        this.animationFinishedListener = null;
                    }
                    
                    this.updateStatus('„Ç≠„É£„É©„ÇØ„Çø„ÉºË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                    
                    // Ë°®ÊÉÖÂÄ§„ÇíÂàùÊúüÂåñ
                    this.initializeExpressionValues();
                    
                    // VRMÂõ∫ÊúâË°®ÊÉÖ„ÇíÁîüÊàê
                    this.generateDynamicExpressions();
                    
                    // Idle4„Ç¢„Ç§„Éâ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
                    await this.startIdleLoop();
                    
                } catch (error) {
                    console.error('„Ç≠„É£„É©„ÇØ„Çø„ÉºË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    this.updateStatus(`Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
                }
            }
            
            async playAnimation(animationName) {
                if (!this.currentVRM || !this.vrmMixer) {
                    console.warn('VRM not loaded');
                    return;
                }
                
                try {
                    // „É´„Éº„Éó„Çπ„É†„Éº„Ç∏„É≥„Ç∞„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                this.stopLoopSmoothing();
                    
                    // Ââç„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÊªë„Çâ„Åã„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                    if (this.currentAction) {
                        this.currentAction.fadeOut(0.3); // 0.3Áßí„Åß„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                        this.currentAction = null;
                    }
                    
                    const animationPath = `${this.animationBasePath}${animationName}.vrma`;
                    
                    const animationGltf = await new Promise((resolve, reject) => {
                        this.loader.load(animationPath, resolve, undefined, reject);
                    });
                    
                    const vrmAnimations = animationGltf.userData.vrmAnimations;
                    if (vrmAnimations && vrmAnimations.length > 0) {
                        const clip = createVRMAnimationClip(vrmAnimations[0], this.currentVRM);
                        this.currentAction = this.vrmMixer.clipAction(clip);
                        
                        // „É´„Éº„Éó„Åó„Å™„ÅÑ„ÉØ„É≥„Ç∑„Éß„ÉÉ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å´Ë®≠ÂÆö
                        this.currentAction.setLoop(THREE.LoopOnce);
                        this.currentAction.clampWhenFinished = true; // ÊúÄÂæå„ÅÆ„Éï„É¨„Éº„É†„ÅßÂÅúÊ≠¢
                        
                        // Êªë„Çâ„Åã„Å´„Éï„Çß„Éº„Éâ„Ç§„É≥
                        this.currentAction.fadeIn(0.3); // 0.3Áßí„Åß„Éï„Çß„Éº„Éâ„Ç§„É≥
                        this.currentAction.play();
                        
                        // Ââç„ÅÆ„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Ç¢
                        if (this.animationFinishedListener && this.vrmMixer) {
                            this.vrmMixer.removeEventListener('finished', this.animationFinishedListener);
                        }
                        
                        // Êñ∞„Åó„ÅÑ„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                        this.animationFinishedListener = (event) => {
                            if (event.action === this.currentAction) {
                                console.log(`„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ${animationName} ÂÆå‰∫Ü - „Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥„Å´ÁßªË°å`);
                                // „É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÈÅ∑Áßª
                                if (this.vrmMixer) {
                                    this.vrmMixer.removeEventListener('finished', this.animationFinishedListener);
                                }
                                this.animationFinishedListener = null;
                                this.transitionToIdleAnimation();
                            }
                        };
                        this.vrmMixer.addEventListener('finished', this.animationFinishedListener);
                        
                        this.updateStatus(`„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÜçÁîü: ${animationName}`);
                        console.log(`„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã: ${animationName} (Ëá™Âãï„Ç¢„Ç§„Éâ„É´ÁßªË°åË®≠ÂÆöÊ∏à„Åø)`);
                    }
                    
                } catch (error) {
                    console.error('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    this.updateStatus(`„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº: ${animationName}`);
                    // „Ç®„É©„ÉºÊôÇ„ÇÇ„Ç¢„Ç§„Éâ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å´Êàª„Çã
                    setTimeout(() => this.transitionToIdleAnimation(), 300);
                }
            }
            
            async playIdleAnimation() {
                await this.startIdleLoop();
            }
            
            // „Ç¢„Ç§„Éâ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å∏„ÅÆÊªë„Çâ„Åã„Å™ÈÅ∑ÁßªÔºàT„Éù„Éº„Ç∫Èò≤Ê≠¢ÊúÄÈÅ©ÂåñÔºâ
            async transitionToIdleAnimation() {
                if (!this.currentVRM || !this.vrmMixer) {
                    return;
                }
                
                try {
                    // „Ç¢„Ç§„Éâ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÖà„Å´Ê∫ñÂÇôÔºàÈáç„Åø0„ÅßÈñãÂßãÔºâ
                    const animationPath = `${this.animationBasePath}Idle4.vrma`;
                    
                    const animationGltf = await new Promise((resolve, reject) => {
                        this.loader.load(
                            animationPath,
                            resolve,
                            progress => console.log(`„Ç¢„Ç§„Éâ„É´Ê∫ñÂÇôÈÄ≤Êçó: ${(progress.loaded / progress.total * 100).toFixed(1)}%`),
                            reject
                        );
                    });
                    
                    const vrmAnimation = animationGltf.userData.vrmAnimations?.[0];
                    if (!vrmAnimation) {
                        throw new Error('Idle4.vrma„ÅÆVRM„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    
                    // Êñ∞„Åó„ÅÑ„Ç¢„Ç§„Éâ„É´„Ç¢„ÇØ„Ç∑„Éß„É≥„Çí‰ΩúÊàêÔºàÈáç„Åø0„ÅßÈñãÂßãÔºâ
                    const newIdleAction = this.vrmMixer.clipAction(vrmAnimation.createAnimationClip(this.currentVRM));
                    newIdleAction.enabled = true;
                    newIdleAction.setLoop(THREE.LoopRepeat);
                    newIdleAction.clampWhenFinished = false;
                    newIdleAction.setEffectiveWeight(0); // ÊúÄÂàù„ÅØÈáç„Åø0
                    newIdleAction.play();
                    
                    // „ÇØ„É≠„Çπ„Éï„Çß„Éº„ÉâÂÆüË°åÔºàT„Éù„Éº„Ç∫„ÇíÂÆåÂÖ®„Å´ÂõûÈÅøÔºâ
                    if (this.currentAction) {
                        // ÂêåÊôÇ„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà„Å®„Éï„Çß„Éº„Éâ„Ç§„É≥
                        this.currentAction.fadeOut(0.3);
                        newIdleAction.fadeIn(0.3);
                        
                        console.log('„ÇØ„É≠„Çπ„Éï„Çß„Éº„ÉâÈÅ∑ÁßªÈñãÂßã - T„Éù„Éº„Ç∫ÂõûÈÅø');
                    } else {
                        // ÁèæÂú®„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁõ¥Êé•„Éï„Çß„Éº„Éâ„Ç§„É≥
                        newIdleAction.fadeIn(0.3);
                    }
                    
                    // „Ç¢„ÇØ„Ç∑„Éß„É≥„Å®„ÇØ„É™„ÉÉ„Éó„ÇíÊõ¥Êñ∞
                    this.currentAction = newIdleAction;
                    this.currentIdleClip = vrmAnimation.createAnimationClip(this.currentVRM);
                    
                    // „É´„Éº„Éó„Çπ„É†„Éº„Ç∏„É≥„Ç∞ÈñãÂßã
                    setTimeout(() => {
                        this.stopLoopSmoothing(); // Êó¢Â≠ò„ÅÆ„Çπ„É†„Éº„Ç∏„É≥„Ç∞„ÇíÂÅúÊ≠¢
                        this.startLoopSmoothing(); // Êñ∞„Åó„ÅÑ„Çπ„É†„Éº„Ç∏„É≥„Ç∞„ÇíÈñãÂßã
                    }, 350); // „Éï„Çß„Éº„Éâ„Ç§„É≥ÂÆå‰∫ÜÂæå„Å´ÈñãÂßã
                    
                } catch (error) {
                    console.error('„Ç¢„Ç§„Éâ„É´ÈÅ∑Áßª„Ç®„É©„Éº:', error);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÈÄöÂ∏∏„ÅÆÈÅ∑Áßª
                    if (this.currentAction) {
                        this.currentAction.fadeOut(0.3);
                    }
                    setTimeout(async () => {
                        await this.startIdleLoop();
                    }, 150);
                }
            }
            
            // „É©„É≥„ÉÄ„É†„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥„ÅÆÈñãÂßã - „Ç´„ÇØ„Å§„ÅçÈò≤Ê≠¢ÊúÄÈÅ©Âåñ
// Êñ∞„Åó„ÅÑ„Ç¢„Ç§„Éâ„É´„É´„Éº„Éó„Ç∑„Çπ„ÉÜ„É†
            async startIdleLoop() {
                if (!this.currentVRM || !this.vrmMixer) {
                    console.warn('VRM not loaded');
                    return;
                }

                const idleAnimations = ['Idle1.vrma', 'Idle2.vrma', 'Idle3.vrma', 'Idle4.vrma'];
                let currentIdleName = '';
                let currentIdleAction = null;
                
                // „Ç¢„Ç§„Éâ„É´„É´„Éº„Éó„ÇíÈñãÂßã„Åô„ÇãÈñ¢Êï∞
                const playNextIdle = async () => {
                    try {
                        // „É©„É≥„ÉÄ„É†„ÅßÊ¨°„ÅÆ„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû
                        const previousIdleName = currentIdleName;
                        let selectedAnimation;
                        
                        // ÁèæÂú®„ÅÆ„É¢„Éº„Ç∑„Éß„É≥„Å®Áï∞„Å™„Çã„É¢„Éº„Ç∑„Éß„É≥„ÇíÂÑ™ÂÖà„Åó„Å¶ÈÅ∏Êäû
                        const availableAnimations = idleAnimations.filter(name => name !== previousIdleName);
                        selectedAnimation = availableAnimations[Math.floor(Math.random() * availableAnimations.length)];
                        
                        currentIdleName = selectedAnimation;
                        const animationPath = `${this.animationBasePath}${currentIdleName}`;
                        
                        console.log(`Ê¨°„ÅÆ„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø‰∏≠: ${currentIdleName}`);

                        const animationGltf = await new Promise((resolve, reject) => {
                            this.loader.load(animationPath, resolve, undefined, reject);
                        });

                        const vrmAnimation = animationGltf.userData.vrmAnimations?.[0];
                        if (!vrmAnimation) {
                            throw new Error(`VRM„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${currentIdleName}`);
                        }

                        const clip = createVRMAnimationClip(vrmAnimation, this.currentVRM);
                        const nextAction = this.vrmMixer.clipAction(clip);
                        
                        nextAction.setLoop(THREE.LoopOnce); // „ÉØ„É≥„Ç∑„Éß„ÉÉ„ÉàÂÜçÁîü„Å´Ë®≠ÂÆö
                        nextAction.clampWhenFinished = true; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÊôÇ„Å´ÊúÄÂæå„ÅÆ„Éï„É¨„Éº„É†„ÅßÂÅúÊ≠¢
                        
                        // Ââç„ÅÆ„Ç¢„Ç§„Éâ„É´„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢
                        if (currentIdleAction) {
                            currentIdleAction.stop();
                        }
                        
                        // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„Å´ÁΩÆ„ÅçÊèõ„Åà
                        this.currentAction = nextAction;
                        currentIdleAction = nextAction;
                        
                        // ÂÜçÁîü
                        nextAction.play();
                        
                        this.updateStatus(`„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥ÂÜçÁîü‰∏≠: ${currentIdleName}`);
                        
                    } catch (error) {
                        console.error('„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥ÂÜçÁîü„Ç®„É©„Éº:', error);
                        this.updateStatus(`„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº: ${currentIdleName}`);
                    }
                };

                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÊôÇ„Å´Ê¨°„ÅÆ„É¢„Éº„Ç∑„Éß„É≥„ÇíÂÜçÁîü
                this.vrmMixer.addEventListener('finished', (event) => {
                    if (event.action === this.currentAction) {
                        console.log(`„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥ ${currentIdleName} ÁµÇ‰∫Ü„ÄÇÊ¨°„ÅÆ„É¢„Éº„Ç∑„Éß„É≥„Å´ÈÅ∑Áßª„Åó„Åæ„Åô„ÄÇ`);
                        playNextIdle();
                    }
                });

                // ÂàùÂõûÂÜçÁîü
                playNextIdle();
            }
            
            setExpression(expressionName) {
                if (!this.currentVRM) return;
                
                try {
                    // „Åæ„ÅöÂÖ®„Å¶„ÅÆË°®ÊÉÖ„Çí„É™„Çª„ÉÉ„Éà
                    this.resetAllExpressionsSync();
                    
                    // Ë°®ÊÉÖ„Éû„ÉÉ„Éî„É≥„Ç∞
                    const expressionMapping = {
                        'happy': 'happy',
                        'angry': 'angry', 
                        'sad': 'sad',
                        'surprised': 'surprised',
                        'relaxed': 'relaxed',
                        'neutral': 'neutral'
                    };
                    
                    const vrmExpression = expressionMapping[expressionName];
                    if (vrmExpression && this.currentVRM.expressionManager) {
                        // Êªë„Çâ„Åã„Å™Ë°®ÊÉÖÂ§âÂåñ„Çí‰ΩøÁî®
                        this.setSmoothExpression(vrmExpression, 1000);
                    }
                } catch (error) {
                    console.error('Ë°®ÊÉÖË®≠ÂÆö„Ç®„É©„Éº:', error);
                }
            }
            
            setSmoothExpression(expressionName, duration = 1200) {
                if (!this.currentVRM) return;
                
                try {
                    // Ë°®ÊÉÖ„Éû„ÉÉ„Éî„É≥„Ç∞
                    const expressionMapping = {
                        'happy': 'happy',
                        'angry': 'angry', 
                        'sad': 'sad',
                        'surprised': 'surprised',
                        'relaxed': 'relaxed',
                        'neutral': 'neutral'
                    };
                    
                    const vrmExpression = expressionMapping[expressionName];
                    if (vrmExpression && this.currentVRM.expressionManager) {
                        // „Åæ„Åö‰ªñ„ÅÆË°®ÊÉÖ„ÇíÊªë„Çâ„Åã„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                        this.fadeOutOtherExpressions(vrmExpression, duration * 0.6);
                        
                        // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶Êñ∞„Åó„ÅÑË°®ÊÉÖ„Çí„Éï„Çß„Éº„Éâ„Ç§„É≥
                        setTimeout(() => {
                            this.animateExpressionTo(vrmExpression, 1.0, duration * 0.8);
                        }, duration * 0.2); // 20%ÈÅÖÂª∂Âæå„Å´„Éï„Çß„Éº„Éâ„Ç§„É≥ÈñãÂßã
                        
                        this.updateStatus(`Ë°®ÊÉÖÂ§âÊõ¥: ${expressionName} (Êªë„Çâ„Åã)`);
                        console.log(`Êªë„Çâ„ÅãË°®ÊÉÖÂ§âÊõ¥: ${expressionName} (${duration}ms)`);
                    }
                } catch (error) {
                    console.error('Êªë„Çâ„ÅãË°®ÊÉÖË®≠ÂÆö„Ç®„É©„Éº:', error);
                }
            }
            
            fadeOutOtherExpressions(excludeExpression, duration = 800) {
                if (!this.currentVRM || !this.currentVRM.expressionManager) return;
                
                // Èô§Â§ñ„Åô„ÇãË°®ÊÉÖ‰ª•Â§ñ„ÇíÂÖ®„Å¶„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                Object.keys(this.currentVRM.expressionManager.expressionMap).forEach(expressionName => {
                    if (expressionName !== excludeExpression && expressionName !== 'blink') {
                        this.animateExpressionTo(expressionName, 0.0, duration);
                    }
                });
            }
            
            startBlinking() {
                if (!this.currentVRM) return;
                
                const blink = () => {
                    if (this.currentVRM && this.currentVRM.expressionManager) {
                        // Ëá™ÁÑ∂„Å™Áû¨„Åç„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºà150ms „ÅßÈñâ„Åò„Å¶„ÄÅ150ms „ÅßÈñã„ÅèÔºâ
                        this.animateExpressionTo('blink', 1.0, 150);
                        
                        // 150msÂæå„Å´ÁõÆ„ÇíÈñã„Åè
                        setTimeout(() => {
                            if (this.currentVRM && this.currentVRM.expressionManager) {
                                this.animateExpressionTo('blink', 0.0, 150);
                            }
                        }, 150);
                    }
                    
                    // Ê¨°„ÅÆ„Åæ„Å∞„Åü„Åç„Çí„É©„É≥„ÉÄ„É†„Å™ÈñìÈöî„ÅßË®≠ÂÆö
                    const nextBlink = Math.random() * 3000 + 1000; // 1-4Áßí
                    this.blinkTimer = setTimeout(blink, nextBlink);
                };
                
                // ÊúÄÂàù„ÅÆ„Åæ„Å∞„Åü„Åç„ÇíË®≠ÂÆö
                this.blinkTimer = setTimeout(blink, 2000);
            }
            
            async playSampleVoice() {
                if (!this.currentVRM) {
                    this.updateStatus('VRM„É¢„Éá„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                
                if (this.isLipSyncActive) {
                    this.stopLipSync();
                    return;
                }
                
                try {
                    this.updateStatus('„Çµ„É≥„Éó„É´Èü≥Â£∞ÂÜçÁîüÈñãÂßã...');
                    
                    // Web Audio APIÂàùÊúüÂåñ
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // „Çµ„É≥„Éó„É´Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÅøÔºà„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„Çí‰ΩøÁî®Ôºâ
                    const timestamp = new Date().getTime();
                    const response = await fetch(`../../backend/src/voice/voice.wav?t=${timestamp}`);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    
                    // „Ç™„Éº„Éá„Ç£„Ç™Ëß£ÊûêË®≠ÂÆö
                    const source = this.audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    
                    this.analyser = this.audioContext.createAnalyser();
                    const gainNode = this.audioContext.createGain();
                    this.analyser.fftSize = 2048;
                    this.analyser.smoothingTimeConstant = 0.8;
                    this.dataArray = new Uint8Array(this.analyser.fftSize);
                    
                    // „Ç™„Éº„Éá„Ç£„Ç™„Éé„Éº„ÉâÊé•Á∂ö
                    source.connect(this.analyser);
                    this.analyser.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // ÂÜçÁîüÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
                    source.onended = () => {
                        this.stopLipSync();
                        this.updateStatus('„Çµ„É≥„Éó„É´Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü');
                        console.log('Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü');
                        
                        // Èü≥Â£∞ÁµÇ‰∫ÜÂæå„ÄÅË°®ÊÉÖ„ÇíÊªë„Çâ„Åã„Å´„Éé„Éº„Éû„É´„Å´Êàª„ÅôÔºà2.5ÁßíÂæå„Å´ÈñãÂßã„ÄÅ1.5Áßí„Åã„Åë„Å¶Ôºâ
                        setTimeout(() => {
                            console.log('[Ë°®ÊÉÖ„É™„Çª„ÉÉ„Éà] Èü≥Â£∞ÁµÇ‰∫ÜÂæå„ÄÅË°®ÊÉÖ„Çí„Éã„É•„Éº„Éà„É©„É´„Å´Êàª„Åó„Åæ„Åô');
                            this.setSmoothExpression('neutral', 1500);
                        }, 2500);
                    };
                    
                    // Èü≥Â£∞ÂÜçÁîüÈñãÂßã
                    source.start();
                    this.isLipSyncActive = true;
                    
                    // Âè£„Éë„ÇØÂ§âÊï∞ÂàùÊúüÂåñ
                    this.lastVowelChangeTime = performance.now();
                    this.currentVowelExpression = 'a';
                    
                    // „Çµ„É≥„Éó„É´Èü≥Â£∞„Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
                    this.sampleVoiceBtn.textContent = 'Èü≥Â£∞ÂÅúÊ≠¢';
                    
                    this.updateStatus('Èü≥Â£∞ÂÜçÁîü‰∏≠ÔºàÂè£„Éë„ÇØ‰ªò„ÅçÔºâ');
                    console.log(`Âè£„Éë„ÇØ‰ªò„ÅçÈü≥Â£∞ÂÜçÁîüÈñãÂßã: ${audioBuffer.duration.toFixed(2)}Áßí`);
                    
                    // „É™„Ç¢„É´„Çø„Ç§„É†Âè£„Éë„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
                    this.startLipSyncAnimation();
                    
                } catch (error) {
                    console.error('Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', error);
                    this.updateStatus(`Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº: ${error.message}`);
                    this.stopLipSync();
                }
            }
            
            stopCurrentAnimation() {
                // „É´„Éº„Éó„Çπ„É†„Éº„Ç∏„É≥„Ç∞„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                this.stopLoopSmoothing();
                
                if (this.currentAction) {
                    this.currentAction.fadeOut(0.3); // 0.3Áßí„ÅßÊªë„Çâ„Åã„Å´ÂÅúÊ≠¢
                    this.currentAction = null;
                }
                
                // Êªë„Çâ„Åã„Å´Idle4„Ç¢„Ç§„Éâ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å´ÈÅ∑Áßª
                setTimeout(() => {
                    this.transitionToIdleAnimation();
                }, 150);
                
                this.updateStatus('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÅúÊ≠¢‰∏≠ - Idle4„Ç¢„Ç§„Éâ„É´Áä∂ÊÖã„Å´ÁßªË°å');
            }
            
            resetAllExpressions() {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    this.updateStatus('VRM„É¢„Éá„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                
                try {
                    // ÂÖ®„Å¶„ÅÆË°®ÊÉÖ„Çí0„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„Åß„É™„Çª„ÉÉ„Éà
                    const expressions = Object.keys(this.currentVRM.expressionManager.expressionMap);
                    expressions.forEach(expressionName => {
                        this.targetExpressionValues[expressionName] = 0.0;
                    });
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
                    this.expressionAnimationDuration = 600; // Â∞ë„ÅóÈÄü„ÇÅ„ÅÆ„É™„Çª„ÉÉ„Éà
                    this.expressionAnimationStartTime = performance.now();
                    this.isExpressionAnimating = true;
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
                    this.startExpressionAnimationLoop();
                    
                    this.updateStatus('ÂÖ®„Å¶„ÅÆË°®ÊÉÖ„Çí„É™„Çª„ÉÉ„Éà‰∏≠...');
                    console.log('ÂÖ®Ë°®ÊÉÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É™„Çª„ÉÉ„ÉàÈñãÂßã');
                } catch (error) {
                    console.error('Ë°®ÊÉÖ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                    this.updateStatus(`Ë°®ÊÉÖ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº: ${error.message}`);
                }
            }
            
            // Â∏∏ÊôÇ„É¢„Éº„Ç∑„Éß„É≥ÈÄî‰∏≠Âàá„ÇäÊõø„Åà„ÉªÂÆåÂÖ®Êªë„Çâ„Åã„Ç∑„Çπ„ÉÜ„É†
            startLoopSmoothing() {
                if (!this.currentAction || !this.currentIdleClip) {
                    return;
                }
                
                const clipDuration = this.currentIdleClip.duration;
                
                // Áä∂ÊÖãÁÆ°ÁêÜÂ§âÊï∞
                let nextIdleMotion = null;
                let isTransitioning = false;
                let switchDecisionCooldown = 0;
                let transitionStartTime = 0;
                const transitionDuration = 1.0; // 1Áßí„ÅÆ„ÇØ„É≠„Çπ„Éï„Çß„Éº„ÉâÊôÇÈñì
                
                // Ë§áÊï∞„Éï„É¨„Éº„É†„Å´„Çè„Åü„ÇãÊôÇÈñìË£úÈñì„Éê„ÉÉ„Éï„Ç°
                let timeHistory = [];
                let lastRealTime = performance.now();
                let lastSwitchTime = performance.now(); // ÂàùÊúüÂåñ
                
                const constantSmoothLoop = () => {
                    if (!this.currentAction || this.currentAction._clip !== this.currentIdleClip) {
                        return;
                    }
                    
                    const now = performance.now();
                    const realDelta = (now - lastRealTime) / 1000;
                    lastRealTime = now;
                    
                    // „Éï„É¨„Éº„É†ÊôÇÈñìÂ±•Ê≠¥„ÇíË®òÈå≤
                    timeHistory.push(realDelta);
                    if (timeHistory.length > 10) {
                        timeHistory.shift();
                    }
                    
                    // Âπ≥ÊªëÂåñ„Åï„Çå„Åü„Éá„É´„Çø„Çø„Ç§„É†„ÇíË®àÁÆó
                    const avgDelta = timeHistory.reduce((sum, delta) => sum + delta, 0) / timeHistory.length;
                    const smoothDelta = this.lerp(realDelta, avgDelta, 0.7);
                    
                    switchDecisionCooldown -= smoothDelta;
                    
                    const currentTime = this.currentAction.time;
                    const normalizedTime = currentTime % clipDuration;
                    
                    // ÂÆöÊúüÁöÑ„Å´„É©„É≥„ÉÄ„É†Âàá„ÇäÊõø„Åà„ÇíÂà§ÂÆöÔºà3ÁßíÂõ∫ÂÆöÈñìÈöî„ÄÅ„É¢„Éº„Ç∑„Éß„É≥ÁµÇ‰∫Ü„Å´‰æùÂ≠ò„Åó„Å™„ÅÑÔºâ
                    if (switchDecisionCooldown <= 0 && !isTransitioning && !nextIdleMotion) {
                        const switchChance = Math.random();
                        
                        if (switchChance < 0.6) {
                            // 60%„ÅÆÁ¢∫Áéá„ÅßÂêå„Åò„É¢„Éº„Ç∑„Éß„É≥„ÇíÁ∂ôÁ∂ö
                            this.prepareSameIdleMotion().then(motion => {
                                if (motion) {
                                    nextIdleMotion = motion;
                                    console.log(`Âêå„É¢„Éº„Ç∑„Éß„É≥Á∂ôÁ∂öÊ∫ñÂÇô: ${motion.name} (Á¢∫Áéá60%)`);
                                }
                            });
                        } else {
                            // 40%„ÅÆÁ¢∫Áéá„Åß4Á®Æ„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏ÊäûÔºàÁµêÊûúÁöÑ„Å´10%„ÅØÂêå„Åò„É¢„Éº„Ç∑„Éß„É≥„Å´„Å™„ÇãÂèØËÉΩÊÄßÔºâ
                            this.prepareRandomIdleMotionFromAll().then(motion => {
                                if (motion) {
                                    nextIdleMotion = motion;
                                    console.log(`„É©„É≥„ÉÄ„É†ÈÅ∏ÊäûÊ∫ñÂÇô: ${motion.name} (Á¢∫Áéá40%„Åã„Çâ„É©„É≥„ÉÄ„É†)`);
                                }
                            });
                        }
                        
                        // Ê¨°„ÅÆÂà§ÂÆö„Åæ„Åß3ÁßíÂõ∫ÂÆö
                        switchDecisionCooldown = 3.0;
                    }
                    
                    // Ê∫ñÂÇôÂÆå‰∫ÜÂæå„Åô„Åê„Å´ÈÄî‰∏≠Âàá„ÇäÊõø„ÅàÈñãÂßãÔºàÁµÇ‰∫ÜÂæÖÊ©ü„Å™„ÅóÔºâ
                    if (nextIdleMotion && !isTransitioning) {
                        isTransitioning = true;
                        transitionStartTime = now;
                        
                        // Êñ∞„Åó„ÅÑ„É¢„Éº„Ç∑„Éß„É≥„Çí‰ªªÊÑè„ÅÆÊôÇÁÇπ„Åã„ÇâÈñãÂßãÔºà„Çà„ÇäËá™ÁÑ∂„Å™Âàá„ÇäÊõø„ÅàÔºâ
                        const startOffset = Math.random() * nextIdleMotion.clip.duration * 0.3; // ÊúÄÂàù„ÅÆ30%ÂÜÖ„Åã„Çâ„É©„É≥„ÉÄ„É†ÈñãÂßã
                        nextIdleMotion.action.setEffectiveWeight(0);
                        nextIdleMotion.action.time = startOffset;
                        nextIdleMotion.action.play();
                        
                        console.log(`„É¢„Éº„Ç∑„Éß„É≥ÈÄî‰∏≠Âàá„ÇäÊõø„ÅàÈñãÂßã: ${nextIdleMotion.name} (ÈñãÂßã‰ΩçÁΩÆ: ${startOffset.toFixed(2)}Áßí)`);
                    }
                    
                    // Â∏∏ÊôÇ„ÇØ„É≠„Çπ„Éï„Çß„Éº„ÉâÈÄ≤Ë°åÔºà1ÁßíÈñìÔºâ
                    if (isTransitioning && nextIdleMotion) {
                        const elapsedTransition = (now - transitionStartTime) / 1000;
                        const fadeProgress = Math.min(1.0, elapsedTransition / transitionDuration);
                        const smoothProgress = this.easeInOutQuart(fadeProgress);
                        
                        const currentWeight = 1.0 - smoothProgress;
                        const nextWeight = smoothProgress;
                        
                        this.currentAction.setEffectiveWeight(currentWeight);
                        nextIdleMotion.action.setEffectiveWeight(nextWeight);
                        
                        // Âàá„ÇäÊõø„ÅàÂÆå‰∫Ü
                        if (fadeProgress >= 1.0) {
                            // Âè§„ÅÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢
                            this.currentAction.stop();
                            
                            // Êñ∞„Åó„ÅÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„Å´Êõ¥Êñ∞
                            this.currentAction = nextIdleMotion.action;
                            this.currentIdleClip = nextIdleMotion.clip;
                            this.currentAction.setEffectiveWeight(1.0);
                            
                            // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
                            nextIdleMotion = null;
                            isTransitioning = false;
                            
                            console.log('„É¢„Éº„Ç∑„Éß„É≥ÈÄî‰∏≠Âàá„ÇäÊõø„ÅàÂÆå‰∫Ü - ÂÆåÂÖ®Êªë„Çâ„ÅãÈÅ∑ÁßªÈÅîÊàê');
                        }
                    }
                    
                    // ÈÄöÂ∏∏„ÅÆÊªë„Çâ„ÅãÂÜçÁîüÔºàÂàá„ÇäÊõø„Åà‰∏≠‰ª•Â§ñÔºâ
                    if (!isTransitioning && this.currentAction && this.currentAction.isRunning()) {
                        // Ê•µÂ∞è„ÅÆÈáç„ÅøÊè∫„Çâ„Åé„ÅßËá™ÁÑ∂„Åï„ÇíÊºîÂá∫
                        const weightFluctuation = 0.998 + (Math.sin(now * 0.01) * 0.002);
                        this.currentAction.setEffectiveWeight(weightFluctuation);
                    }
                    
                    this.loopSmoothingFrame = requestAnimationFrame(constantSmoothLoop);
                };
                
                // ÂàùÊúüÂåñÊôÇ„Å´ÊúÄÂàù„ÅÆÂàá„ÇäÊõø„ÅàÂà§ÂÆöÊôÇÈñì„ÇíË®≠ÂÆöÔºà3ÁßíÂõ∫ÂÆöÔºâ
                switchDecisionCooldown = 3.0;
                lastSwitchTime = performance.now();
                
                this.loopSmoothingFrame = requestAnimationFrame(constantSmoothLoop);
                console.log('Â∏∏ÊôÇ„É¢„Éº„Ç∑„Éß„É≥ÈÄî‰∏≠Âàá„ÇäÊõø„Åà„ÉªÂÆåÂÖ®Êªë„Çâ„Åã„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã (60%Á∂ôÁ∂ö+40%„É©„É≥„ÉÄ„É†=70%/30%)');
            }
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇØ„É™„ÉÉ„Éó„ÅÆ„É´„Éº„ÉóÊúÄÈÅ©Âåñ
            optimizeAnimationClipForLoop() {
                if (!this.currentIdleClip) return;
                
                try {
                    // „ÇØ„É™„ÉÉ„Éó„ÅÆ„Éà„É©„ÉÉ„ÇØ„ÇíËß£Êûê
                    this.currentIdleClip.tracks.forEach(track => {
                        if (track.times && track.times.length > 1) {
                            const values = track.values;
                            const times = track.times;
                            const lastIndex = times.length - 1;
                            
                            // ÊúÄÂàù„Å®ÊúÄÂæå„ÅÆÂÄ§„ÅÆÂ∑Æ„ÇíË®àÁÆó
                            const valueSize = values.length / times.length;
                            const startValues = values.slice(0, valueSize);
                            const endValues = values.slice(-valueSize);
                            
                            // ÁµÇÁ´ØÂÄ§„ÇíÈñãÂßãÂÄ§„Å´Ëøë„Å•„Åë„Å¶ÂÆåÂÖ®„É´„Éº„Éó„Çí‰ΩúÊàê
                            for (let i = 0; i < valueSize; i++) {
                                const diff = endValues[i] - startValues[i];
                                if (Math.abs(diff) > 0.001) {
                                    // ÊÆµÈöéÁöÑ„Å´Ë£úÊ≠£ÔºàÊÄ•ÊøÄ„Å™Â§âÊõ¥„ÇíÈÅø„Åë„ÇãÔºâ
                                    values[values.length - valueSize + i] = this.lerp(endValues[i], startValues[i], 0.8);
                                }
                            }
                        }
                    });
                    
                    console.log('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇØ„É™„ÉÉ„Éó„ÅÆ„É´„Éº„Éó„Éù„Ç§„É≥„Éà„ÇíÊúÄÈÅ©Âåñ');
                } catch (error) {
                    console.warn('„ÇØ„É™„ÉÉ„ÉóÊúÄÈÅ©Âåñ„Åß„Ç®„É©„ÉºÔºàÁ∂ôÁ∂öÂèØËÉΩÔºâ:', error);
                }
            }
            
            // Á∑öÂΩ¢Ë£úÈñì„Éò„É´„Éë„Éº
            lerp(start, end, factor) {
                return start + (end - start) * Math.max(0, Math.min(1, factor));
            }
            
            // Âêå„Åò„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Á∂ôÁ∂öÊ∫ñÂÇô
            async prepareSameIdleMotion() {
                try {
                    // ÁèæÂú®„ÅÆ„É¢„Éº„Ç∑„Éß„É≥Âêç„ÇíÂèñÂæó
                    let currentIdleName = 'Idle4.vrma'; // „Éá„Éï„Ç©„É´„Éà
                    if (this.currentIdleClip && this.currentIdleClip.name) {
                        const match = this.currentIdleClip.name.match(/Idle\d\.vrma/);
                        if (match) {
                            currentIdleName = match[0];
                        }
                    }
                    
                    const animationPath = `${this.animationBasePath}${currentIdleName}`;
                    
                    console.log(`Âêå„Åò„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Á∂ôÁ∂ö: ${currentIdleName}`);
                    
                    const animationGltf = await new Promise((resolve, reject) => {
                        this.loader.load(animationPath, resolve, undefined, reject);
                    });
                    
                    const vrmAnimation = animationGltf.userData.vrmAnimations?.[0];
                    if (!vrmAnimation) {
                        throw new Error(`${currentIdleName}„ÅÆVRM„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                    }
                    
                    const animationClip = vrmAnimation.createAnimationClip(this.currentVRM);
                    const nextAction = this.vrmMixer.clipAction(animationClip);
                    nextAction.enabled = true;
                    nextAction.setLoop(THREE.LoopRepeat);
                    nextAction.clampWhenFinished = false;
                    nextAction.time = 0;
                    
                    return {
                        name: currentIdleName,
                        action: nextAction,
                        clip: animationClip
                    };
                    
                } catch (error) {
                    console.error('Âêå„Åò„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Á∂ôÁ∂öÊ∫ñÂÇô„Ç®„É©„Éº:', error);
                    return null;
                }
            }
            
            // 4Á®Æ„Åô„Åπ„Å¶„Åã„Çâ„É©„É≥„ÉÄ„É†„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Ê∫ñÂÇô
            async prepareRandomIdleMotionFromAll() {
                try {
                    const idleAnimations = ['Idle1.vrma', 'Idle2.vrma', 'Idle3.vrma', 'Idle4.vrma'];
                    
                    // 4Á®Æ„Åô„Åπ„Å¶„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´ÈÅ∏ÊäûÔºàÂêå„Åò„É¢„Éº„Ç∑„Éß„É≥„ÅÆÂèØËÉΩÊÄß„ÇÇÂê´„ÇÄÔºâ
                    const selectedAnimation = idleAnimations[Math.floor(Math.random() * idleAnimations.length)];
                    const animationPath = `${this.animationBasePath}${selectedAnimation}`;
                    
                    // ÁèæÂú®„ÅÆ„É¢„Éº„Ç∑„Éß„É≥Âêç„ÇíÂèñÂæó
                    let currentIdleName = 'Idle4.vrma'; // „Éá„Éï„Ç©„É´„Éà
                    if (this.currentIdleClip && this.currentIdleClip.name) {
                        const match = this.currentIdleClip.name.match(/Idle\d\.vrma/);
                        if (match) {
                            currentIdleName = match[0];
                        }
                    }
                    
                    const isSameMotion = selectedAnimation === currentIdleName;
                    console.log(`4Á®Æ„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû: ${currentIdleName} ‚Üí ${selectedAnimation} ${isSameMotion ? '(Âêå„Åò)' : '(Â§âÊõ¥)'}`);
                    
                    const animationGltf = await new Promise((resolve, reject) => {
                        this.loader.load(
                            animationPath,
                            resolve,
                            progress => console.log(`${selectedAnimation} Ë™≠„ÅøËæº„ÅøÈÄ≤Êçó: ${(progress.loaded / progress.total * 100).toFixed(1)}%`),
                            reject
                        );
                    });
                    
                    const vrmAnimation = animationGltf.userData.vrmAnimations?.[0];
                    if (!vrmAnimation) {
                        throw new Error(`${selectedAnimation}„ÅÆVRM„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                    }
                    
                    const animationClip = vrmAnimation.createAnimationClip(this.currentVRM);
                    const nextAction = this.vrmMixer.clipAction(animationClip);
                    nextAction.enabled = true;
                    nextAction.setLoop(THREE.LoopRepeat);
                    nextAction.clampWhenFinished = false;
                    nextAction.time = 0;
                    
                    return {
                        name: selectedAnimation,
                        action: nextAction,
                        clip: animationClip,
                        isSameMotion: isSameMotion
                    };
                    
                } catch (error) {
                    console.error('4Á®Æ„É©„É≥„ÉÄ„É†„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Ê∫ñÂÇô„Ç®„É©„Éº:', error);
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Idle4.vrma„Çí‰ΩøÁî®
                    try {
                        const fallbackPath = `${this.animationBasePath}Idle4.vrma`;
                        const animationGltf = await new Promise((resolve, reject) => {
                            this.loader.load(fallbackPath, resolve, undefined, reject);
                        });
                        
                        const vrmAnimation = animationGltf.userData.vrmAnimations?.[0];
                        const animationClip = vrmAnimation.createAnimationClip(this.currentVRM);
                        const nextAction = this.vrmMixer.clipAction(animationClip);
                        nextAction.enabled = true;
                        nextAction.setLoop(THREE.LoopRepeat);
                        nextAction.clampWhenFinished = false;
                        nextAction.time = 0;
                        
                        console.log('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Idle4.vrma„Çí‰ΩøÁî®');
                        return {
                            name: 'Idle4.vrma',
                            action: nextAction,
                            clip: animationClip,
                            isSameMotion: false
                        };
                        
                    } catch (fallbackError) {
                        console.error('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇÇÂ§±Êïó:', fallbackError);
                        return null;
                    }
                }
            }
            
            // „É©„É≥„ÉÄ„É†„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Ê∫ñÂÇôÔºàÊó¢Â≠ò„ÅÆÈô§Â§ñÁâà„ÄÅ‰∫íÊèõÊÄßÁ∂≠ÊåÅÁî®Ôºâ
            async prepareRandomIdleMotion() {
                try {
                    const idleAnimations = ['Idle1.vrma', 'Idle2.vrma', 'Idle3.vrma', 'Idle4.vrma'];
                    
                    // ÁèæÂú®„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âêç„ÇíÂèñÂæó
                    let currentIdleName = 'Idle4.vrma'; // „Éá„Éï„Ç©„É´„Éà
                    if (this.currentIdleClip && this.currentIdleClip.name) {
                        const match = this.currentIdleClip.name.match(/Idle\d\.vrma/);
                        if (match) {
                            currentIdleName = match[0];
                        }
                    }
                    
                    // ÁèæÂú®„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ª•Â§ñ„ÅÆÈÅ∏ÊäûËÇ¢„Çí‰ΩúÊàê
                    const availableAnimations = idleAnimations.filter(name => name !== currentIdleName);
                    
                    // „É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
                    const selectedAnimation = availableAnimations[Math.floor(Math.random() * availableAnimations.length)];
                    const animationPath = `${this.animationBasePath}${selectedAnimation}`;
                    
                    console.log(`„É©„É≥„ÉÄ„É†„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥ÈÅ∏Êäû: ${currentIdleName} ‚Üí ${selectedAnimation}`);
                    
                    const animationGltf = await new Promise((resolve, reject) => {
                        this.loader.load(
                            animationPath,
                            resolve,
                            progress => console.log(`${selectedAnimation} Ë™≠„ÅøËæº„ÅøÈÄ≤Êçó: ${(progress.loaded / progress.total * 100).toFixed(1)}%`),
                            reject
                        );
                    });
                    
                    const vrmAnimation = animationGltf.userData.vrmAnimations?.[0];
                    if (!vrmAnimation) {
                        throw new Error(`${selectedAnimation}„ÅÆVRM„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                    }
                    
                    const animationClip = vrmAnimation.createAnimationClip(this.currentVRM);
                    const nextAction = this.vrmMixer.clipAction(animationClip);
                    nextAction.enabled = true;
                    nextAction.setLoop(THREE.LoopRepeat);
                    nextAction.clampWhenFinished = false;
                    nextAction.time = 0;
                    
                    return {
                        name: selectedAnimation,
                        action: nextAction,
                        clip: animationClip
                    };
                    
                } catch (error) {
                    console.error('„É©„É≥„ÉÄ„É†„Ç¢„Ç§„Éâ„É´„É¢„Éº„Ç∑„Éß„É≥Ê∫ñÂÇô„Ç®„É©„Éº:', error);
                    return null;
                }
            }
            
            // Ê¨°„ÅÆ„Ç¢„Ç§„Éâ„É´„Ç¢„ÇØ„Ç∑„Éß„É≥„Çí„Éó„É™„É≠„Éº„ÉâÔºà‰∫íÊèõÊÄßÁ∂≠ÊåÅÁî®Ôºâ
            async preloadNextIdleAction() {
                const motion = await this.prepareRandomIdleMotion();
                return motion ? motion.action : null;
            }
            
            // „É´„Éº„Éó„Çπ„É†„Éº„Ç∏„É≥„Ç∞ÂÅúÊ≠¢
            stopLoopSmoothing() {
                if (this.loopSmoothingFrame) {
                    cancelAnimationFrame(this.loopSmoothingFrame);
                    this.loopSmoothingFrame = null;
                }
                
                this.currentIdleClip = null;
            }
            
            // Ë∂ÖÈ´òÁ≤æÂ∫¶„Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞Áæ§
            easeInOutSine(t) {
                return -(Math.cos(Math.PI * t) - 1) / 2;
            }
            
            easeInOutQuart(t) {
                return t < 0.5 ? 8 * t * t * t * t : 1 - Math.pow(-2 * t + 2, 4) / 2;
            }
            
            // ÂêåÊúüÁöÑË°®ÊÉÖ„É™„Çª„ÉÉ„ÉàÔºàË°®ÊÉÖÂàá„ÇäÊõø„ÅàÁî®Ôºâ
            resetAllExpressionsSync() {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                try {
                    const expressions = Object.keys(this.currentVRM.expressionManager.expressionMap);
                    expressions.forEach(expressionName => {
                        this.currentVRM.expressionManager.setValue(expressionName, 0.0);
                        this.currentExpressionValues[expressionName] = 0.0;
                        this.targetExpressionValues[expressionName] = 0.0;
                    });
                    this.currentVRM.expressionManager.update();
                    console.log('Ë°®ÊÉÖ„ÇíÂêåÊúüÁöÑ„Å´„É™„Çª„ÉÉ„Éà');
                } catch (error) {
                    console.error('ÂêåÊúüË°®ÊÉÖ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                }
            }
            
            generateDynamicExpressions() {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                // ÂãïÁöÑË°®ÊÉÖ„Ç∞„É™„ÉÉ„Éâ„Çí„ÇØ„É™„Ç¢
                this.dynamicExpressionsGrid.innerHTML = '';
                
                const expressions = Object.keys(this.currentVRM.expressionManager.expressionMap);
                console.log(`VRMÂõ∫ÊúâË°®ÊÉÖ„ÇíÁîüÊàê: ${expressions.length}ÂÄã`);
                
                if (expressions.length === 0) {
                    this.dynamicExpressionsGrid.innerHTML = '<p style="color: #ccc; font-style: italic;">Âà©Áî®ÂèØËÉΩ„Å™Ë°®ÊÉÖ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    return;
                }
                
                // Âü∫Êú¨Ë°®ÊÉÖÔºàhappy, angry, sadÁ≠âÔºâ„ÇíÈô§Â§ñ
                const basicExpressions = ['happy', 'angry', 'sad', 'surprised', 'relaxed', 'neutral'];
                const vrmSpecificExpressions = expressions.filter(expr => {
                    const lowerExpr = expr.toLowerCase();
                    return !basicExpressions.some(basic => lowerExpr.includes(basic));
                });
                
                vrmSpecificExpressions.forEach(expressionName => {
                    const button = document.createElement('button');
                    button.textContent = expressionName;
                    button.className = 'expression-btn';
                    
                    // Ë°®ÊÉÖ„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíËøΩÂä†
                    const lowerName = expressionName.toLowerCase();
                    if (this.isLipSyncExpression(lowerName)) {
                        button.classList.add('mouth-expression');
                    } else if (this.isEyeExpression(lowerName)) {
                        button.classList.add('eye-expression');
                    }
                    
                    // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                    button.addEventListener('click', () => {
                        this.setVRMExpression(expressionName, 1.0);
                    });
                    
                    this.dynamicExpressionsGrid.appendChild(button);
                });
                
                console.log(`VRMÂõ∫ÊúâË°®ÊÉÖ„Éú„Çø„É≥ÁîüÊàêÂÆå‰∫Ü: ${vrmSpecificExpressions.length}ÂÄã`);
            }
            
            isLipSyncExpression(expressionName) {
                const mouthKeywords = ['a', 'i', 'u', 'e', 'o', 'aa', 'ih', 'ou', 'ee', 'oh', 'mouth', 'lip'];
                return mouthKeywords.some(keyword => expressionName.includes(keyword));
            }
            
            isEyeExpression(expressionName) {
                const eyeKeywords = ['blink', 'eye', 'wink', 'look'];
                return eyeKeywords.some(keyword => expressionName.includes(keyword));
            }
            
            setVRMExpression(expressionName, value = 1.0) {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                try {
                    // „Åæ„ÅöÂÖ®„Å¶„ÅÆË°®ÊÉÖ„Çí„É™„Çª„ÉÉ„Éà
                    this.resetAllExpressionsSync();
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„ÅßË°®ÊÉÖ„ÇíË®≠ÂÆö
                    setTimeout(() => {
                        this.animateExpressionTo(expressionName, value);
                    }, 100); // „É™„Çª„ÉÉ„ÉàÂæå„Å´Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶ÈÅ©Áî®
                    this.updateStatus(`Ë°®ÊÉÖË®≠ÂÆö: ${expressionName} (${(value * 100).toFixed(0)}%)`);
                    console.log(`VRMË°®ÊÉÖË®≠ÂÆö: ${expressionName} = ${value}`);
                } catch (error) {
                    console.error('VRMË°®ÊÉÖË®≠ÂÆö„Ç®„É©„Éº:', error);
                    this.updateStatus(`Ë°®ÊÉÖË®≠ÂÆö„Ç®„É©„Éº: ${error.message}`);
                }
            }
            
            initializeExpressionValues() {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                this.currentExpressionValues = {};
                this.targetExpressionValues = {};
                
                // ÂÖ®„Å¶„ÅÆË°®ÊÉÖ„Çí0„ÅßÂàùÊúüÂåñ
                Object.keys(this.currentVRM.expressionManager.expressionMap).forEach(expressionName => {
                    this.currentExpressionValues[expressionName] = 0.0;
                    this.targetExpressionValues[expressionName] = 0.0;
                });
                
                console.log(`Ë°®ÊÉÖÂÄ§„ÇíÂàùÊúüÂåñ: ${Object.keys(this.currentExpressionValues).length}ÂÄã`);
            }
            
            animateExpressionTo(expressionName, targetValue, duration = 800) {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                // ÂØæË±°„ÅÆË°®ÊÉÖ„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (!this.currentVRM.expressionManager.expressionMap[expressionName]) {
                    console.warn(`Ë°®ÊÉÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${expressionName}`);
                    return;
                }
                
                // ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                if (this.currentExpressionValues[expressionName] === undefined) {
                    this.currentExpressionValues[expressionName] = 0.0;
                }
                
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÂÄ§„ÇíË®≠ÂÆö
                this.targetExpressionValues[expressionName] = Math.max(0, Math.min(1, targetValue));
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
                this.expressionAnimationDuration = duration;
                this.expressionAnimationStartTime = performance.now();
                this.isExpressionAnimating = true;
                
                console.log(`Ë°®ÊÉÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã: ${expressionName} -> ${targetValue}`);
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó„ÇíÈñãÂßã
                this.startExpressionAnimationLoop();
            }
            
            startExpressionAnimationLoop() {
                if (this.expressionAnimationFrame) {
                    cancelAnimationFrame(this.expressionAnimationFrame);
                }
                
                const animateFrame = () => {
                    if (!this.isExpressionAnimating || !this.currentVRM || !this.currentVRM.expressionManager) {
                        return;
                    }
                    
                    const currentTime = performance.now();
                    const elapsed = currentTime - this.expressionAnimationStartTime;
                    const progress = Math.min(elapsed / this.expressionAnimationDuration, 1.0);
                    
                    // „Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞ÔºàÊªë„Çâ„Åã„Å™Â§âÂåñÔºâ
                    const easedProgress = this.easeInOutCubic(progress);
                    
                    let hasChanges = false;
                    
                    // ÂêÑË°®ÊÉÖÂÄ§„ÇíË£úÈñì
                    Object.keys(this.targetExpressionValues).forEach(expressionName => {
                        if (!this.currentVRM.expressionManager.expressionMap[expressionName]) {
                            return;
                        }
                        
                        const currentValue = this.currentExpressionValues[expressionName] || 0.0;
                        const targetValue = this.targetExpressionValues[expressionName] || 0.0;
                        
                        if (Math.abs(currentValue - targetValue) > 0.001) {
                            // Á∑öÂΩ¢Ë£úÈñì
                            const newValue = this.lerp(currentValue, targetValue, easedProgress);
                            this.currentExpressionValues[expressionName] = newValue;
                            
                            // VRM„Å´ÈÅ©Áî®
                            try {
                                this.currentVRM.expressionManager.setValue(expressionName, newValue);
                                hasChanges = true;
                            } catch (error) {
                                console.error(`Ë°®ÊÉÖË®≠ÂÆö„Ç®„É©„Éº ${expressionName}:`, error);
                            }
                        }
                    });
                    
                    // VRMÊõ¥Êñ∞
                    if (hasChanges) {
                        try {
                            this.currentVRM.expressionManager.update();
                        } catch (error) {
                            console.error('Ë°®ÊÉÖ„Éû„Éç„Éº„Ç∏„É£„ÉºÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                        }
                    }
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Á∂ôÁ∂öÂà§ÂÆö
                    if (progress < 1.0) {
                        this.expressionAnimationFrame = requestAnimationFrame(animateFrame);
                    } else {
                        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü
                        this.isExpressionAnimating = false;
                        this.expressionAnimationFrame = null;
                        
                        // ÊúÄÁµÇÂÄ§„ÇíÁ¢∫ÂÆü„Å´Ë®≠ÂÆö
                        Object.keys(this.targetExpressionValues).forEach(expressionName => {
                            if (this.currentVRM.expressionManager.expressionMap[expressionName]) {
                                const finalValue = this.targetExpressionValues[expressionName];
                                this.currentExpressionValues[expressionName] = finalValue;
                                try {
                                    this.currentVRM.expressionManager.setValue(expressionName, finalValue);
                                } catch (error) {
                                    console.error(`ÊúÄÁµÇÂÄ§Ë®≠ÂÆö„Ç®„É©„Éº ${expressionName}:`, error);
                                }
                            }
                        });
                        
                        if (this.currentVRM && this.currentVRM.expressionManager) {
                            this.currentVRM.expressionManager.update();
                        }
                        
                        console.log('Ë°®ÊÉÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü');
                    }
                };
                
                this.expressionAnimationFrame = requestAnimationFrame(animateFrame);
            }
            
            easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }
            
            // „Çà„ÇäÊªë„Çâ„Åã„Å™„Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞
            easeInOutQuint(t) {
                return t < 0.5 ? 16 * t * t * t * t * t : 1 - Math.pow(-2 * t + 2, 5) / 2;
            }
            
            lerp(start, end, t) {
                return start + (end - start) * t;
            }
            
            stopLipSync() {
                this.isLipSyncActive = false;
                
                // Web Audio APIÂÅúÊ≠¢
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close().catch(console.error);
                    this.audioContext = null;
                }
                
                // Ëß£ÊûêÂ§âÊï∞„Çí„ÇØ„É™„Ç¢
                this.analyser = null;
                this.dataArray = null;
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†ÂÅúÊ≠¢
                if (this.lipSyncAnimationFrame) {
                    cancelAnimationFrame(this.lipSyncAnimationFrame);
                    this.lipSyncAnimationFrame = null;
                }
                
                // Âè£„ÅÆË°®ÊÉÖ„Çí„É™„Çª„ÉÉ„Éà
                this.resetLipSyncExpressions();
                
                // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊàª„Åô
                this.sampleVoiceBtn.textContent = '„Çµ„É≥„Éó„É´Èü≥Â£∞ÂÜçÁîü';
                
                this.updateStatus('Èü≥Â£∞ÂÅúÊ≠¢');
                console.log('Âè£„Éë„ÇØÂÅúÊ≠¢');
            }
            
            startLipSyncAnimation() {
                if (!this.analyser || !this.dataArray || !this.isLipSyncActive) {
                    return;
                }
                
                const animateFrame = () => {
                    if (!this.isLipSyncActive || !this.analyser || !this.dataArray) {
                        return;
                    }
                    
                    // „Ç™„Éº„Éá„Ç£„Ç™„Éá„Éº„ÇøÂèñÂæó
                    this.analyser.getByteTimeDomainData(this.dataArray);
                    
                    // RMSÔºàÈü≥ÈáèÔºâË®àÁÆó
                    let sum = 0;
                    for (let i = 0; i < this.dataArray.length; i++) {
                        const val = (this.dataArray[i] - 128) / 128;
                        sum += val * val;
                    }
                    const rms = Math.sqrt(sum / this.dataArray.length);
                    
                    // Âè£„ÅÆÈñã„ÅçÂÖ∑ÂêàÔºà0.0 to 1.0Ôºâ
                    const mouthOpenIntensity = Math.min(rms * 8, 1.0);
                    
                    // ÊØçÈü≥Â§âÊõ¥Ôºà120ms„Åî„Å®Ôºâ
                    const now = performance.now();
                    if (now - this.lastVowelChangeTime > 120) {
                        if (mouthOpenIntensity > 0.1) {
                            this.currentVowelExpression = this.lipSyncVowels[Math.floor(Math.random() * this.lipSyncVowels.length)];
                        } else {
                            this.currentVowelExpression = 'a';
                        }
                        this.lastVowelChangeTime = now;
                    }
                    
                    // ÊúÄÂ∞èÂº∑Â∫¶„Çí‰øù„Å§
                    const finalIntensity = Math.max(mouthOpenIntensity, 0.05);
                    
                    // Âè£„Éë„ÇØË°®ÊÉÖ„ÇíÈÅ©Áî®
                    if (finalIntensity > 0.05) {
                        this.setLipSyncExpression(this.currentVowelExpression, finalIntensity);
                    }
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Á∂ôÁ∂ö
                    this.lipSyncAnimationFrame = requestAnimationFrame(animateFrame);
                };
                
                console.log('„É™„Ç¢„É´„Çø„Ç§„É†Âè£„Éë„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã');
                this.lipSyncAnimationFrame = requestAnimationFrame(animateFrame);
            }
            
            setLipSyncExpression(vowelSound, value = 1.0) {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                try {
                    // ÊØçÈü≥„Å´ÂØæÂøú„Åô„ÇãË°®ÊÉÖÂêç„ÅÆ„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥
                    const expressionVariants = {
                        'a': ['aa', 'A', 'a', 'Aa'],
                        'i': ['ih', 'I', 'i', 'Ih'],
                        'u': ['ou', 'U', 'u', 'Ou'],
                        'e': ['ee', 'E', 'e', 'Ee'],
                        'o': ['oh', 'O', 'o', 'Oh']
                    };
                    
                    // Âà©Áî®ÂèØËÉΩ„Å™Ë°®ÊÉÖ„ÇíÊé¢„Åô
                    const variants = expressionVariants[vowelSound] || [];
                    let foundExpression = null;
                    
                    for (const variant of variants) {
                        if (this.currentVRM.expressionManager.expressionMap[variant]) {
                            foundExpression = variant;
                            break;
                        }
                    }
                    
                    if (!foundExpression) {
                        return;
                    }
                    
                    // ‰ªñ„ÅÆÂè£„ÅÆË°®ÊÉÖ„Çí„É™„Çª„ÉÉ„Éà
                    const allMouthExpressions = ['aa', 'ih', 'ou', 'ee', 'oh', 'A', 'I', 'U', 'E', 'O', 'a', 'i', 'u', 'e', 'o'];
                    allMouthExpressions.forEach(expr => {
                        if (this.currentVRM.expressionManager.expressionMap[expr]) {
                            this.currentVRM.expressionManager.setValue(expr, 0.0);
                        }
                    });
                    
                    // ÂØæË±°„ÅÆË°®ÊÉÖ„ÇíË®≠ÂÆö
                    this.currentVRM.expressionManager.setValue(foundExpression, value);
                    this.currentVRM.expressionManager.update();
                    
                } catch (error) {
                    console.error('Âè£„Éë„ÇØË°®ÊÉÖË®≠ÂÆö„Ç®„É©„Éº:', error);
                }
            }
            
            resetLipSyncExpressions() {
                if (!this.currentVRM || !this.currentVRM.expressionManager) {
                    return;
                }
                
                try {
                    // ÂÖ®„Å¶„ÅÆÂè£„ÅÆË°®ÊÉÖ„Çí„É™„Çª„ÉÉ„Éà
                    const allMouthExpressions = ['aa', 'ih', 'ou', 'ee', 'oh', 'A', 'I', 'U', 'E', 'O', 'a', 'i', 'u', 'e', 'o'];
                    allMouthExpressions.forEach(expr => {
                        if (this.currentVRM.expressionManager.expressionMap[expr]) {
                            this.currentVRM.expressionManager.setValue(expr, 0.0);
                        }
                    });
                    this.currentVRM.expressionManager.update();
                } catch (error) {
                    console.error('Âè£„Éë„ÇØ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                }
            }
            
            disposeCurrentVRM() {
                if (this.currentAction) {
                    this.currentAction.fadeOut(0.3);
                    this.currentAction = null;
                }
                
                // „É´„Éº„Éó„Çπ„É†„Éº„Ç∏„É≥„Ç∞„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                this.stopLoopSmoothing();
                
                if (this.vrmMixer) {
                    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Ç¢
                    if (this.animationFinishedListener) {
                        this.vrmMixer.removeEventListener('finished', this.animationFinishedListener);
                        this.animationFinishedListener = null;
                    }
                    this.vrmMixer.stopAllAction();
                    this.vrmMixer = null;
                }
                
                if (this.blinkTimer) {
                    clearTimeout(this.blinkTimer);
                    this.blinkTimer = null;
                }
                
                // Âè£„Éë„ÇØ„É™„ÇΩ„Éº„Çπ„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                if (this.isLipSyncActive) {
                    this.stopLipSync();
                }
                
                // „É°„Éã„É•„Éº„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢ÔºàÁÑ°ÂäπÂåñÔºâ
                // this.clearMenuAutoHideTimer();
                
                // Èü≥Â£∞„Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
                if (this.voicePollingInterval) {
                    clearInterval(this.voicePollingInterval);
                    this.voicePollingInterval = null;
                }
                
                // „ÅîÊ©üÂ´åÂ∫¶„Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
                if (this.moodPollingInterval) {
                    clearInterval(this.moodPollingInterval);
                    this.moodPollingInterval = null;
                }
                
                // ÊÑüÊÉÖ„ÉªË°®ÊÉÖ„Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
                if (this.emotionPollingInterval) {
                    clearInterval(this.emotionPollingInterval);
                    this.emotionPollingInterval = null;
                }
                if (this.expressionPollingInterval) {
                    clearInterval(this.expressionPollingInterval);
                    this.expressionPollingInterval = null;
                }
                
                // Live2D„Çπ„Çø„Ç§„É´„Åß„ÅØËá™ÂãïÊõ¥Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂÅúÊ≠¢Âá¶ÁêÜ„ÅØ‰∏çË¶Å
                console.log('üì∏ Live2D„Çπ„Çø„Ç§„É´„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Ç∑„Çπ„ÉÜ„É† (Ëá™ÂãïÊõ¥Êñ∞„Å™„Åó)');
                
                if (this.currentVRM) {
                    this.scene.remove(this.currentVRM.scene);
                    // VRM„É™„ÇΩ„Éº„Çπ„ÅÆËß£Êîæ
                    VRMUtils.deepDispose(this.currentVRM.scene);
                    this.currentVRM = null;
                }
            }
            
            startAnimationLoop() {
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    const deltaTime = this.vrmClock.getDelta();
                    
                    // VRM„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Êõ¥Êñ∞
                    if (this.vrmMixer) {
                        this.vrmMixer.update(deltaTime);
                    }
                    
                    // VRMÊõ¥Êñ∞
                    if (this.currentVRM) {
                        this.currentVRM.update(deltaTime);
                    }
                    
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                };
                
                animate();
            }
            
            handleResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            updateStatus(message) {
                this.statusDisplay.textContent = message;
                console.log('Status:', message);
            }
            
            hideLoading() {
                this.loadingOverlay.classList.add('hidden');
            }
            
            // Ë¶ñÁÇπË°®Á§∫Âàá„ÇäÊõø„ÅàÈñ¢Êï∞ÔºàLive2D„Çπ„Çø„Ç§„É´Ôºâ
            toggleVision() {
                this.isVisionVisible = !this.isVisionVisible;
                
                if (this.isVisionVisible) {
                    this.aiTuberVision.classList.remove('hidden');
                    // Live2D„Å®Âêå„Åò„Åè„ÄÅË°®Á§∫ÊôÇ„Å´ÊâãÂãïÊõ¥Êñ∞„ÅÆ„ÅøÂÆüË°å
                    setTimeout(() => this.updateScreenshotManually(), 100);
                } else {
                    this.aiTuberVision.classList.add('hidden');
                }
            }
            
            // AITuberË¶ñÁÇπÁîªÂÉè„ÅÆÂà∂Âæ°Èñ¢Êï∞ÔºàLive2D„Ç∑„É≥„Éó„É´ÊñπÂºèÔºâ
            setVisionImage(imageSrc, width = 300, height = 200) {
                const visionContainer = this.aiTuberVision;
                const visionImage = this.visionImage;
                const visionPlaceholder = this.visionPlaceholder;
                
                // „Ç≥„É≥„ÉÜ„Éä„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
                visionContainer.style.width = width + 'px';
                visionContainer.style.height = height + 'px';
                
                if (imageSrc) {
                    // Live2D„Ç∑„Çπ„ÉÜ„É†„Å®Âêå„Åò„Ç∑„É≥„Éó„É´„Å™ÊñπÂºè
                    visionImage.src = imageSrc;
                    visionImage.style.display = 'block';
                    visionPlaceholder.style.display = 'none';
                    
                    // „Ç®„É©„ÉºÊôÇ„ÅÆ„ÅøÂá¶ÁêÜÔºàÂàùÊúüÂåñ„ÅØ„Åó„Å™„ÅÑÔºâ
                    visionImage.onerror = () => {
                        console.log('‚ö†Ô∏è ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÔºàÁ∂ôÁ∂öÂãï‰ΩúÔºâ');
                        // Êó¢Â≠ò„ÅÆË°®Á§∫„ÇíÁ∂≠ÊåÅ
                    };
                } else {
                    // ÂàùÂõû„ÅÆ„Åø„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíË°®Á§∫
                    visionImage.style.display = 'none';
                    visionPlaceholder.style.display = 'flex';
                    visionPlaceholder.innerHTML = `
                        <div class="icon">üëÄ</div>
                        <div>ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    `;
                }
            }
            
            // ÁîªÂÉè„Çí„ÇØ„É™„Ç¢„Åô„ÇãÈñ¢Êï∞
            clearVisionImage() {
                this.setVisionImage(null);
            }
            
            // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÂàùÊúüÂåñÔºàLive2D„Ç∑„É≥„Éó„É´ÊñπÂºèÔºâ
            initializeScreenshotAutoUpdate() {
                // Áµ±‰∏Ä„Åï„Çå„Åü„Éë„Çπ„Çí‰ΩøÁî®
                const screenshotPath = '../../backend/src/image/screenshot.png';
                
                // ÂàùÂõûË®≠ÂÆöÔºàLive2D„Å®Âêå„Åò„Ç∑„É≥„Éó„É´„Å™ÊñπÂºèÔºâ
                this.setVisionImage(screenshotPath, 300, 200);
                
                console.log('üì∏ „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÂàùÊúüË®≠ÂÆöÂÆå‰∫Ü (Live2DÊñπÂºè)');
                
                // Ëá™ÂãïÊõ¥Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅØÁÑ°ÂäπÂåñÔºàLive2D„Å®Âêå„ÅòÔºâ
                // „Éï„Ç°„Ç§„É´„Åå‰∏äÊõ∏„Åç„Åï„Çå„Å¶„ÇÇ„Éñ„É©„Ç¶„Ç∂„Éº„ÅåËá™Âãï„ÅßÊõ¥Êñ∞„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂàùÊúüÂåñ„ÅØÁô∫Áîü„Åó„Å™„ÅÑ
            }
            
            // ÊâãÂãï„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊõ¥Êñ∞ÔºàÂøÖË¶ÅÊôÇ„ÅÆ„Åø‰ΩøÁî®Ôºâ
            updateScreenshotManually() {
                const currentTime = Date.now();
                
                // ÈÄ£Á∂öÊõ¥Êñ∞„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅÊúÄ‰Ωé1ÁßíÈñìÈöî„ÇíË®≠„Åë„Çã
                if (currentTime - this.lastScreenshotUpdate < 1000) {
                    console.log('‚è±Ô∏è Êõ¥Êñ∞ÈñìÈöî„ÅåÁü≠„Åô„Åé„Åæ„Åô„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô');
                    return;
                }
                
                this.lastScreenshotUpdate = currentTime;
                
                // Live2D„Å®Âêå„Åò„Ç∑„É≥„Éó„É´„Å™Êõ¥Êñ∞ÊñπÂºè
                const basePath = '../../backend/src/image/screenshot.png';
                const timestamp = currentTime;
                const newImageSrc = basePath + '?manual=' + timestamp;
                
                // Áõ¥Êé•Êõ¥Êñ∞ÔºàLive2D„Çπ„Çø„Ç§„É´Ôºâ
                this.setVisionImage(newImageSrc, 300, 200);
                
                console.log('üîÑ ÊâãÂãï„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊõ¥Êñ∞: ' + new Date().toLocaleTimeString());
            }

            // Â≠óÂπïË°®Á§∫„É°„ÇΩ„ÉÉ„Éâ - Ê¨°„ÅÆÊõ¥Êñ∞„Åæ„ÅßË°®Á§∫Á∂öË°å&Ë®≠ÂÆöÂØæÂøú
            updateSubtitle(subtitleText) {
                // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
                if (this.subtitleClearTimer) {
                    clearTimeout(this.subtitleClearTimer);
                    this.subtitleClearTimer = null;
                }
                
                if (!subtitleText || subtitleText.trim() === '') {
                    this.subtitle.classList.remove('show');
                    return;
                }
                
                // <br>„ÅßÊó•Êú¨Ë™û„Å®Ëã±Ë™û„ÇíÂàÜÂâ≤
                let japanese = '';
                let english = '';
                
                if (subtitleText.includes('<br>')) {
                    const parts = subtitleText.split('<br>');
                    japanese = parts[0] ? parts[0].trim() : '';
                    english = parts[1] ? parts[1].trim() : '';
                } else {
                    japanese = subtitleText.trim();
                }
                
                // Ë®≠ÂÆö„Å´Âü∫„Å•„ÅÑ„Å¶Ë°®Á§∫„ÉÜ„Ç≠„Çπ„Éà„ÇíÊßãÁØâ
                let displayParts = [];
                if (this.subtitleSettings.showJapanese && japanese) {
                    displayParts.push(japanese);
                }
                if (this.subtitleSettings.showEnglish && english) {
                    displayParts.push(`(${english})`);
                }
                
                if (displayParts.length === 0) {
                    this.subtitle.classList.remove('show');
                    return;
                }
                
                const displayText = displayParts.join(' ');
                this.subtitle.textContent = displayText;
                this.subtitle.classList.add('show');
                
                // Ê¨°„ÅÆÊõ¥Êñ∞„Åæ„ÅßË°®Á§∫Á∂öË°åÔºà„Çø„Ç§„Éû„Éº„ÅØË®≠ÂÆö„Åó„Å™„ÅÑÔºâ
                console.log('Â≠óÂπïË°®Á§∫:', displayText);
            }
            
            // Flask API„Åã„Çâ„ÅÆÂ≠óÂπïÂèó‰ø°ÔºàWebSocketÊé•Á∂öÔºâ
            initializeSubtitleConnection() {
                // WebSocketÊé•Á∂ö„ÇíË©¶Ë°åÔºàÈñãÁô∫Áí∞Â¢ÉÁî®Ôºâ
                try {
                    this.subtitleSocket = new WebSocket('ws://localhost:5000/subtitle');
                    
                    this.subtitleSocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.japanese) {
                            // <br>„ÅßÂå∫Âàá„Çâ„Çå„ÅüÂΩ¢Âºè„Å´Â§âÊèõ
                            const fullText = data.japanese + (data.english ? '<br>' + data.english : '');
                            this.updateSubtitle(fullText);
                        }
                    };
                    
                    this.subtitleSocket.onopen = () => {
                        console.log('Â≠óÂπïWebSocketÊé•Á∂öÊàêÂäü');
                    };
                    
                    this.subtitleSocket.onerror = (error) => {
                        console.log('Â≠óÂπïWebSocketÊé•Á∂öÂ§±ÊïóÔºàÈÄöÂ∏∏Âãï‰ΩúÔºâ:', error);
                    };
                    
                } catch (error) {
                    console.log('WebSocketÊú™ÂØæÂøú„Åæ„Åü„ÅØÊé•Á∂öÂ§±Êïó');
                }
                
                // HTTP API pollingÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                this.initializeSubtitlePolling();
            }
            
            // HTTP API polling for subtitle updates
            initializeSubtitlePolling() {
                setInterval(async () => {
                    try {
                        const response = await fetch('http://127.0.0.1:5000/subtitle');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.japanese && data.timestamp > this.lastSubtitleTimestamp) {
                                // <br>„ÅßÂå∫Âàá„Çâ„Çå„ÅüÂΩ¢Âºè„Å´Â§âÊèõ
                                const fullText = data.japanese + (data.english ? '<br>' + data.english : '');
                                this.updateSubtitle(fullText);
                                this.lastSubtitleTimestamp = data.timestamp;
                            }
                        }
                    } catch (error) {
                        // APIÊé•Á∂öÂ§±ÊïóÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÄöÂ∏∏Âãï‰ΩúÔºâ
                    }
                }, 500); // 500ms„Åî„Å®„Å´„Éù„Éº„É™„É≥„Ç∞
            }
            
            // Èü≥Â£∞ÂÜçÁîü„Éù„Éº„É™„É≥„Ç∞ÂàùÊúüÂåñ
            initializeVoicePolling() {
                this.voicePollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch('http://127.0.0.1:5000/voice');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.play === true) {
                                const now = new Date().toLocaleTimeString();
                                console.log(`[${now}] Èü≥Â£∞ÂÜçÁîüÊåáÁ§∫„ÇíÂèó‰ø° - Êñ∞„Åó„ÅÑÈü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÅøÈñãÂßã`);
                                this.playVoiceFile();
                            }
                        }
                    } catch (error) {
                        // „Çµ„Éº„Éê„ÉºÊé•Á∂öÂ§±ÊïóÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÄöÂ∏∏Âãï‰ΩúÔºâ
                    }
                }, 200); // 200ms„Åî„Å®„Å´„Éù„Éº„É™„É≥„Ç∞ÔºàÈü≥Â£∞„ÅØÁ¥†Êó©„ÅèÂèçÂøú„Åï„Åõ„ÇãÔºâ
            }
            
            // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÂè£„Éë„ÇØ‰ªò„Åç„ÅßÂÜçÁîü
            async playVoiceFile() {
                if (!this.currentVRM) {
                    console.warn('VRM„É¢„Éá„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                
                if (this.isLipSyncActive) {
                    console.log('Êó¢„Å´Èü≥Â£∞ÂÜçÁîü‰∏≠„Åß„Åô');
                    return;
                }
                
                try {
                    this.updateStatus('Ëá™ÂãïÈü≥Â£∞ÂÜçÁîüÈñãÂßã...');
                    
                    // Web Audio APIÂàùÊúüÂåñ
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÅøÔºà„Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„Çí‰ΩøÁî®Ôºâ
                    const timestamp = new Date().getTime();
                    const response = await fetch(`../../backend/src/voice/voice.wav?t=${timestamp}`);
                    if (!response.ok) {
                        throw new Error('Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    
                    // „Ç™„Éº„Éá„Ç£„Ç™Ëß£ÊûêË®≠ÂÆö
                    const source = this.audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    
                    this.analyser = this.audioContext.createAnalyser();
                    const gainNode = this.audioContext.createGain();
                    this.analyser.fftSize = 2048;
                    this.analyser.smoothingTimeConstant = 0.8;
                    this.dataArray = new Uint8Array(this.analyser.fftSize);
                    
                    // „Ç™„Éº„Éá„Ç£„Ç™„Éé„Éº„ÉâÊé•Á∂ö
                    source.connect(this.analyser);
                    this.analyser.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // ÂÜçÁîüÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
                    source.onended = () => {
                        this.stopLipSync();
                        this.updateStatus('Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü - Ê¨°„ÅÆÈü≥Â£∞ÂæÖÊ©ü‰∏≠');
                        console.log('Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü - Ê¨°„ÅÆÈü≥Â£∞„Éï„Ç°„Ç§„É´ÂæÖÊ©ü‰∏≠');
                        
                        // Èü≥Â£∞ÁµÇ‰∫ÜÂæå„ÄÅË°®ÊÉÖ„ÇíÊªë„Çâ„Åã„Å´„Éé„Éº„Éû„É´„Å´Êàª„ÅôÔºà2ÁßíÂæå„Å´ÈñãÂßã„ÄÅ1.8Áßí„Åã„Åë„Å¶Ôºâ
                        setTimeout(() => {
                            console.log('[Ë°®ÊÉÖ„É™„Çª„ÉÉ„Éà] Ëá™ÂãïÈü≥Â£∞ÁµÇ‰∫ÜÂæå„ÄÅË°®ÊÉÖ„Çí„Éã„É•„Éº„Éà„É©„É´„Å´Êàª„Åó„Åæ„Åô');
                            this.setSmoothExpression('neutral', 1800);
                            this.currentEmotionalExpression = 'neutral'; // Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                        }, 2000);
                    };
                    
                    // Èü≥Â£∞ÂÜçÁîüÈñãÂßã
                    source.start();
                    this.isLipSyncActive = true;
                    
                    // Âè£„Éë„ÇØÂ§âÊï∞ÂàùÊúüÂåñ
                    this.lastVowelChangeTime = performance.now();
                    this.currentVowelExpression = 'a';
                    
                    this.updateStatus('Ëá™ÂãïÈü≥Â£∞ÂÜçÁîü‰∏≠ÔºàÂè£„Éë„ÇØ‰ªò„ÅçÔºâ');
                    console.log(`Êñ∞„Åó„ÅÑÈü≥Â£∞„Éï„Ç°„Ç§„É´ÂÜçÁîüÈñãÂßã: ${audioBuffer.duration.toFixed(2)}Áßí (timestamp: ${timestamp})`);
                    
                    // „É™„Ç¢„É´„Çø„Ç§„É†Âè£„Éë„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
                    this.startLipSyncAnimation();
                    
                } catch (error) {
                    console.error('Ëá™ÂãïÈü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', error);
                    this.updateStatus(`Ëá™ÂãïÈü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº: ${error.message}`);
                    this.stopLipSync();
                }
            }
            
            // „ÅîÊ©üÂ´åÂ∫¶„Éù„Éº„É™„É≥„Ç∞ÂàùÊúüÂåñ
            initializeMoodPolling() {
                this.moodPollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch('http://127.0.0.1:5000/mood');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.mood !== undefined && data.mood !== this.currentMoodValue) {
                                this.updateMoodDisplay(data.mood);
                                this.currentMoodValue = data.mood;
                            }
                        }
                    } catch (error) {
                        // „Çµ„Éº„Éê„ÉºÊé•Á∂öÂ§±ÊïóÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÄöÂ∏∏Âãï‰ΩúÔºâ
                    }
                }, 1000); // 1Áßí„Åî„Å®„Å´„Éù„Éº„É™„É≥„Ç∞
            }
            
            // ÊÑüÊÉÖ„ÉªË°®ÊÉÖ„Éù„Éº„É™„É≥„Ç∞ÂàùÊúüÂåñ
            initializeEmotionPolling() {
                // ÊÑüÊÉÖ/„É¢„Éº„Ç∑„Éß„É≥„Éù„Éº„É™„É≥„Ç∞
                this.emotionPollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch('http://127.0.0.1:5000/vrm/motion');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.emotion && data.emotion !== this.currentEmotion) {
                                this.handleEmotionUpdate(data.emotion);
                                this.currentEmotion = data.emotion;
                            }
                        }
                    } catch (error) {
                        // „Çµ„Éº„Éê„ÉºÊé•Á∂öÂ§±ÊïóÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÄöÂ∏∏Âãï‰ΩúÔºâ
                    }
                }, 1000); // 1Áßí„Åî„Å®„Å´„Éù„Éº„É™„É≥„Ç∞
                
                // Ë°®ÊÉÖ„Éù„Éº„É™„É≥„Ç∞
                this.expressionPollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch('http://127.0.0.1:5000/expression');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.expression && data.expression !== this.currentExpressionFromBackend) {
                                this.handleExpressionUpdate(data.expression);
                                this.currentExpressionFromBackend = data.expression;
                            }
                        }
                    } catch (error) {
                        // „Çµ„Éº„Éê„ÉºÊé•Á∂öÂ§±ÊïóÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÈÄöÂ∏∏Âãï‰ΩúÔºâ
                    }
                }, 1000); // 1Áßí„Åî„Å®„Å´„Éù„Éº„É™„É≥„Ç∞
            }
            
            // ÊÑüÊÉÖ„Å´Âü∫„Å•„Åè„É¢„Éº„Ç∑„Éß„É≥ÂÜçÁîü
            handleEmotionUpdate(emotion) {
                console.log(`[ÊÑüÊÉÖÊõ¥Êñ∞] Âèó‰ø°: ${emotion}`);
                
                // ÊÑüÊÉÖ„ÇíÂØæÂøú„Åô„ÇãVRMA„Éï„Ç°„Ç§„É´Âêç„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                const emotionToAnimation = {
                    'normal': 'Relax',
                    'angry': 'Angry', 
                    'sad': 'Sad',
                    'happy': 'Clapping',
                    'excited': 'Jump',
                    'blush': 'Blush',
                    'surprised': 'Surprised',
                    'sleepy': 'Sleepy',
                    'thinking': 'Thinking',
                    'relax': 'Relax',
                    'goodbye': 'Goodbye'
                };
                
                const animationName = emotionToAnimation[emotion];
                if (animationName) {
                    console.log(`[ÊÑüÊÉÖÊõ¥Êñ∞] „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÜçÁîü: ${animationName}`);
                    this.playAnimation(animationName);
                } else {
                    console.log(`[ÊÑüÊÉÖÊõ¥Êñ∞] Êú™ÂØæÂøú„ÅÆÊÑüÊÉÖ: ${emotion}, „Éá„Éï„Ç©„É´„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÜçÁîü`);
                    this.playAnimation('Relax');
                }
            }
            
            // Ë°®ÊÉÖÊõ¥Êñ∞„ÅÆÂá¶ÁêÜ
            handleExpressionUpdate(expression) {
                console.log(`[Ë°®ÊÉÖÊõ¥Êñ∞] Âèó‰ø°: ${expression}`);
                
                // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„ÇâÂèó‰ø°„Åó„ÅüË°®ÊÉÖ„ÇíVRMË°®ÊÉÖ„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                const backendToVRMExpression = {
                    'normal': 'neutral',
                    'angry': 'angry',
                    'sad': 'sad', 
                    'happy': 'happy',
                    'excited': 'happy',
                    'blush': 'happy',
                    'surprised': 'surprised',
                    'sleepy': 'relaxed',
                    'thinking': 'neutral',
                    'relax': 'relaxed',
                    'goodbye': 'neutral'
                };
                
                const vrmExpression = backendToVRMExpression[expression] || 'neutral';
                console.log(`[Ë°®ÊÉÖÊõ¥Êñ∞] VRMË°®ÊÉÖË®≠ÂÆö: ${vrmExpression}`);
                
                // Êªë„Çâ„Åã„Å™Ë°®ÊÉÖÂ§âÂåñÔºà1.2ÁßíÔºâ
                this.setSmoothExpression(vrmExpression, 1200);
                
                // ÁèæÂú®„ÅÆË°®ÊÉÖ„ÇíË®òÈå≤ÔºàÈü≥Â£∞ÁµÇ‰∫ÜÊôÇ„ÅÆ„É™„Çª„ÉÉ„ÉàÁî®Ôºâ
                this.currentEmotionalExpression = vrmExpression;
            }
            
            // „ÅîÊ©üÂ´åÂ∫¶„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
            updateMoodDisplay(moodValue) {
                // 0-100„ÅÆÁØÑÂõ≤„Å´Âà∂Èôê
                moodValue = Math.max(0, Math.min(100, moodValue));
                
                // Êï∞ÂÄ§Ë°®Á§∫„ÇíÊõ¥Êñ∞
                this.moodValue.textContent = moodValue;
                
                // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞Ôºà‰∏ãÈÉ®0%„Åã„Çâ‰∏äÈÉ®100%Ôºâ
                const percentage = moodValue; // 0-100
                const bottomPosition = (percentage / 100) * 160; // 160px„ÅØË™øÊï¥Âæå„ÅÆÈ´ò„Åï
                this.moodIndicator.style.bottom = bottomPosition + 'px';
                
                // „É≠„Ç∞Âá∫Âäõ
                console.log(`„ÅîÊ©üÂ´åÂ∫¶Êõ¥Êñ∞: ${moodValue}`);
            }
            
            // „ÉÜ„Éº„Éû„Ç´„É©„ÉºÂ§âÊõ¥„É°„ÇΩ„ÉÉ„Éâ
            changeTheme(themeName) {
                const themes = {
                    pink: {
                        primary: '#ff1493',
                        secondary: '#ffb6c1',
                        bgStart: 'rgba(255, 240, 245, 0.95)',
                        bgEnd: 'rgba(255, 228, 235, 0.9)',
                        shadow: 'rgba(255, 20, 147, 0.4)'
                    },
                    blue: {
                        primary: '#1e90ff',
                        secondary: '#87ceeb',
                        bgStart: 'rgba(240, 248, 255, 0.95)',
                        bgEnd: 'rgba(230, 245, 255, 0.9)',
                        shadow: 'rgba(30, 144, 255, 0.4)'
                    },
                    green: {
                        primary: '#32cd32',
                        secondary: '#98fb98',
                        bgStart: 'rgba(240, 255, 240, 0.95)',
                        bgEnd: 'rgba(230, 255, 230, 0.9)',
                        shadow: 'rgba(50, 205, 50, 0.4)'
                    },
                    purple: {
                        primary: '#9370db',
                        secondary: '#dda0dd',
                        bgStart: 'rgba(248, 240, 255, 0.95)',
                        bgEnd: 'rgba(240, 230, 255, 0.9)',
                        shadow: 'rgba(147, 112, 219, 0.4)'
                    },
                    orange: {
                        primary: '#ff8c00',
                        secondary: '#ffd700',
                        bgStart: 'rgba(255, 250, 240, 0.95)',
                        bgEnd: 'rgba(255, 245, 220, 0.9)',
                        shadow: 'rgba(255, 140, 0, 0.4)'
                    },
                    cyan: {
                        primary: '#00ced1',
                        secondary: '#b0e0e6',
                        bgStart: 'rgba(240, 255, 255, 0.95)',
                        bgEnd: 'rgba(225, 255, 255, 0.9)',
                        shadow: 'rgba(0, 206, 209, 0.4)'
                    },
                    red: {
                        primary: '#dc143c',
                        secondary: '#ffb6c1',
                        bgStart: 'rgba(255, 245, 238, 0.95)',
                        bgEnd: 'rgba(255, 240, 235, 0.9)',
                        shadow: 'rgba(220, 20, 60, 0.4)'
                    },
                    yellow: {
                        primary: '#ffd700',
                        secondary: '#ffffe0',
                        bgStart: 'rgba(255, 255, 240, 0.95)',
                        bgEnd: 'rgba(255, 250, 205, 0.9)',
                        shadow: 'rgba(255, 215, 0, 0.4)'
                    },
                    indigo: {
                        primary: '#4b0082',
                        secondary: '#dda0dd',
                        bgStart: 'rgba(248, 240, 255, 0.95)',
                        bgEnd: 'rgba(238, 220, 255, 0.9)',
                        shadow: 'rgba(75, 0, 130, 0.4)'
                    },
                    teal: {
                        primary: '#008080',
                        secondary: '#afeeee',
                        bgStart: 'rgba(240, 255, 255, 0.95)',
                        bgEnd: 'rgba(224, 255, 255, 0.9)',
                        shadow: 'rgba(0, 128, 128, 0.4)'
                    },
                    magenta: {
                        primary: '#ff00ff',
                        secondary: '#ff69b4',
                        bgStart: 'rgba(255, 240, 255, 0.95)',
                        bgEnd: 'rgba(255, 228, 255, 0.9)',
                        shadow: 'rgba(255, 0, 255, 0.4)'
                    },
                    lime: {
                        primary: '#32cd32',
                        secondary: '#90ee90',
                        bgStart: 'rgba(240, 255, 240, 0.95)',
                        bgEnd: 'rgba(224, 255, 224, 0.9)',
                        shadow: 'rgba(50, 205, 50, 0.4)'
                    }
                };
                
                const theme = themes[themeName];
                if (theme) {
                    const root = document.documentElement;
                    root.style.setProperty('--theme-primary', theme.primary);
                    root.style.setProperty('--theme-secondary', theme.secondary);
                    root.style.setProperty('--theme-bg-start', theme.bgStart);
                    root.style.setProperty('--theme-bg-end', theme.bgEnd);
                    root.style.setProperty('--theme-shadow', theme.shadow);
                    
                    this.updateStatus(`„ÉÜ„Éº„Éû„Çí„Äå${themeName}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`);
                    console.log(`„ÉÜ„Éº„ÉûÂ§âÊõ¥: ${themeName}`);
                }
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†ÈñãÂßã
        window.addEventListener('load', () => {
            new VRMAITuberSystem();
        });
    </script>
</body>
</html>
